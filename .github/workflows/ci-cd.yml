name: ci-cd

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Tag (default latest)"
        required: false
        default: "latest"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  PYTHON_VERSION: "3.11"
  REGISTRY_IMAGE: ghcr.io/${{ github.repository_owner }}/necessito-web

jobs:
  test:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        options: >-
          --health-cmd="pg_isready -U test -d test" --health-interval=5s --health-timeout=5s --health-retries=5
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd="redis-cli ping" --health-interval=5s --health-timeout=5s --health-retries=5
    env:
      DJANGO_SETTINGS_MODULE: core.settings.ci
      DB_HOST: postgres
      DB_NAME: test
      DB_USER: test
      DB_PASSWORD: test
      REDIS_HOST: redis
      SECRET_KEY: test-secret-key-for-ci
      GIT_COMMIT_SHA: ${{ github.sha }}
      BUILD_DATE: ${{ github.run_id }}
      PYTHONPATH: .
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        id: py
        uses: actions/setup-python@v5
        with: 
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-py${{ steps.py.outputs.python-version }}-${{ hashFiles('requirements_*.txt') }}
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_base.txt
          pip install ruff bandit
      - name: Lint
        run: ruff check .
      - name: Security check
        run: bandit -q -r . -ll || true
      - name: Django system check
        run: python manage.py check
      - name: Run migrations
        run: python manage.py migrate --noinput
      - name: Collect static files
        run: python manage.py collectstatic --noinput
      - name: Run tests
        run: python manage.py test --noinput

  build_push:
    timeout-minutes: 20
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_IMAGE }}
          tags: |
            type=sha
            type=raw,value=latest
      - name: Build & Push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            GIT_COMMIT_SHA=${{ github.sha }}
            BUILD_DATE=${{ github.run_id }}
      - name: Export digest
        run: echo "${{ steps.build.outputs.digest }}" > digest.txt
      - uses: actions/upload-artifact@v4
        with:
          name: image-digest
          path: digest.txt

  deploy:
    timeout-minutes: 10
    if: ${{ github.event_name == 'workflow_dispatch' }}
    needs: build_push
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://necessito.online
    steps:
      - uses: actions/download-artifact@v4
        with: 
          name: image-digest
          path: .
      - name: Read digest
        id: dig
        run: echo "DIGEST=$(cat digest.txt)" >> $GITHUB_OUTPUT
      - name: Check secrets
        # Verificação segura de secrets sem usar sintaxe inválida de indexação (causava falha antes de qualquer job rodar)
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          missing=0
          for s in SSH_KEY SSH_HOST SSH_USER; do
            v="${!s}"
            if [ -z "$v" ]; then
              echo "[ERRO] Secret $s ausente" >&2
              missing=1
            else
              echo "[OK] $s presente"
            fi
          done
          if [ "$missing" = 1 ]; then
            exit 1
          fi
      - uses: actions/checkout@v4
        with: 
          sparse-checkout: 'scripts'
          sparse-checkout-cone-mode: false
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with: 
          ssh-private-key: ${{ secrets.SSH_KEY }}
      - name: Known hosts
        run: ssh-keyscan -p 22 "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
      - name: Deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          REGISTRY_IMAGE: ${{ env.REGISTRY_IMAGE }}
          IMAGE_DIGEST: ${{ steps.dig.outputs.DIGEST }}
        run: |
          # Upload scripts
          rsync -avz scripts/ $SSH_USER@$SSH_HOST:~/necessito/scripts/
          # Deploy using digest
          ssh $SSH_USER@$SSH_HOST "cd necessito && REGISTRY_IMAGE=$REGISTRY_IMAGE IMAGE_DIGEST=$IMAGE_DIGEST ./scripts/deploy.sh"
      - name: Remote health check
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: ssh $SSH_USER@$SSH_HOST "curl -fsS https://necessito.online/health/"
