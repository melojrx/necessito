{% comment %}
Mapa de Localiza√ß√£o - Componente Responsivo
Usage: {% include 'components/_mapa_localizacao.html' with necessidade=necessidade %}
Requer: Leaflet CSS/JS globais no base.html
{% endcomment %}

<div class="mapa-localizacao-component">
    <div class="card shadow-sm h-100">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Localiza√ß√£o Aproximada</h6>
        </div>
        <div class="card-body p-0">
            {% if necessidade.tem_coordenadas_mapa %}
                <div id="map-localizacao" 
                     class="map-container"
                     data-lat="{{ necessidade.get_latitude_mapa }}"
                     data-lon="{{ necessidade.get_longitude_mapa }}"
                     data-cidade="{{ necessidade.get_cidade_mapa }}"
                     data-estado="{{ necessidade.get_estado_mapa }}"
                     data-bairro="{{ necessidade.get_bairro_mapa }}">
                </div>
                <div class="p-3 small text-muted">
                    {% if necessidade.get_cidade_mapa %}<div><strong>Cidade:</strong> {{ necessidade.get_cidade_mapa }}</div>{% endif %}
                    {% if necessidade.get_estado_mapa %}<div><strong>Estado:</strong> {{ necessidade.get_estado_mapa }}</div>{% endif %}
                    {% if necessidade.get_bairro_mapa %}<div><strong>Bairro:</strong> {{ necessidade.get_bairro_mapa }}</div>{% endif %}
                    {% if necessidade.usar_endereco_usuario %}
                        <div class="text-info small mt-2"><i class="fas fa-info-circle me-1"></i>Localiza√ß√£o baseada no endere√ßo do anunciante</div>
                    {% endif %}
                </div>
            {% else %}
                <div class="p-4 text-center text-muted">
                    <i class="fas fa-map-marker-alt fa-2x mb-2 text-secondary"></i>
                    <div><strong>Localiza√ß√£o n√£o dispon√≠vel</strong></div>
                    <small>As coordenadas de localiza√ß√£o n√£o foram informadas.</small>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
(function() {
    // Vari√°vel global para armazenar a inst√¢ncia do mapa (evita m√∫ltiplas inicializa√ß√µes)
    let mapInstance = null;

    function initMap() {
        const el = document.getElementById('map-localizacao');
        if (!el) {
            console.warn('Elemento map-localizacao n√£o encontrado');
            return;
        }

        // CORRE√á√ÉO CR√çTICA: Substituir v√≠rgula por ponto (formato brasileiro ‚Üí formato JS)
        const lat = parseFloat((el.dataset.lat || '').replace(',', '.'));
        const lon = parseFloat((el.dataset.lon || '').replace(',', '.'));

        if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
            el.innerHTML = '<div class="alert alert-light text-center m-3">Localiza√ß√£o n√£o dispon√≠vel.</div>';
            return;
        }

        if (typeof L === 'undefined') {
            console.warn('Leaflet n√£o carregado ainda, aguardando...');
            el.innerHTML = '<div class="alert alert-info text-center m-3"><i class="fas fa-spinner fa-spin me-2"></i>Carregando mapa...</div>';
            return false;
        }

        try {
            // CORRE√á√ÉO 1: Destruir mapa existente antes de criar novo (evita memory leak)
            if (mapInstance) {
                console.log('Removendo inst√¢ncia anterior do mapa...');
                mapInstance.remove();
                mapInstance = null;
            }

            // CORRE√á√ÉO 2: Verificar se o container j√° tem uma inst√¢ncia (evita erro "Map container is already initialized")
            if (el._leaflet_id) {
                console.log('Container j√° tinha inst√¢ncia do Leaflet, limpando...');
                delete el._leaflet_id;
            }

            // CORRE√á√ÉO 3: Configura√ß√µes otimizadas do mapa
            mapInstance = L.map('map-localizacao', {
                zoomControl: true,
                attributionControl: true,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                dragging: true,
                tap: true,
                touchZoom: true,
                preferCanvas: false, // SVG para melhor qualidade
                fadeAnimation: true,
                zoomAnimation: true,
                markerZoomAnimation: true
            }).setView([lat, lon], 13);

            // CORRE√á√ÉO 4: Configurar tile layer com retry e error handling
            const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
                minZoom: 3,
                tileSize: 256,
                detectRetina: true, // Suporte a telas retina
                updateWhenZooming: false, // Melhor performance
                keepBuffer: 2
            });

            // Event listener para erros no carregamento de tiles
            tileLayer.on('tileerror', function(error) {
                console.warn('Erro ao carregar tile do mapa:', error);
            });

            tileLayer.addTo(mapInstance);

            // CORRE√á√ÉO 5: Criar marcador com √≠cone customizado
            const marker = L.marker([lat, lon], {
                title: 'Localiza√ß√£o do Servi√ßo',
                alt: 'Marcador de localiza√ß√£o',
                riseOnHover: true
            }).addTo(mapInstance);

            // Obter informa√ß√µes do elemento para o popup
            const cidade = el.dataset.cidade || '';
            const estado = el.dataset.estado || '';
            const bairro = el.dataset.bairro || '';

            let popupContent = '<div class="text-center" style="min-width: 150px;"><strong>üìç Localiza√ß√£o do Servi√ßo</strong><br>';
            if (cidade && estado) {
                popupContent += `<span style="font-size: 0.9rem;">${cidade}, ${estado}</span>`;
                if (bairro) popupContent += `<br><small class="text-muted">Bairro: ${bairro}</small>`;
            } else {
                popupContent += '<small>Localiza√ß√£o aproximada</small>';
            }
            popupContent += '</div>';

            marker.bindPopup(popupContent, {
                closeButton: true,
                autoClose: false,
                className: 'custom-popup'
            });

            // CORRE√á√ÉO 6: invalidateSize() robusto com m√∫ltiplos timings
            // Necess√°rio para corrigir renderiza√ß√£o em tabs, modals, carross√©is, etc.
            const invalidateSizeTimes = [100, 250, 500, 1000];
            invalidateSizeTimes.forEach(delay => {
                setTimeout(() => {
                    if (mapInstance) {
                        mapInstance.invalidateSize({ animate: false });
                    }
                }, delay);
            });

            // CORRE√á√ÉO 7: Listener para resize do window
            const resizeObserver = new ResizeObserver(() => {
                if (mapInstance) {
                    mapInstance.invalidateSize({ animate: false });
                }
            });
            resizeObserver.observe(el);

            // CORRE√á√ÉO 8: Listener para quando o elemento se torna vis√≠vel (tabs, collapse, etc.)
            const intersectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && mapInstance) {
                        setTimeout(() => {
                            mapInstance.invalidateSize({ animate: false });
                        }, 100);
                    }
                });
            }, { threshold: 0.1 });
            intersectionObserver.observe(el);

            // CORRE√á√ÉO 9: Event listener para quando o mapa √© carregado
            mapInstance.whenReady(function() {
                console.log('Mapa Leaflet completamente carregado e pronto');
                // Ajustar tamanho final
                setTimeout(() => {
                    if (mapInstance) {
                        mapInstance.invalidateSize({ animate: false });
                    }
                }, 200);
            });

            console.log('Mapa inicializado com sucesso:', { lat, lon, cidade, estado, bairro });

            // CORRE√á√ÉO 10: Armazenar inst√¢ncia no elemento para acesso global se necess√°rio
            el._mapInstance = mapInstance;

            return true;

        } catch (error) {
            console.error('Erro cr√≠tico ao inicializar mapa:', error);
            el.innerHTML = '<div class="alert alert-danger text-center m-3"><i class="fas fa-exclamation-triangle me-2"></i>Erro ao carregar mapa. <small class="d-block mt-1">Tente recarregar a p√°gina.</small></div>';
            return false;
        }
    }

    // Fun√ß√£o que aguarda o Leaflet estar dispon√≠vel
    function waitForLeaflet(callback, maxAttempts = 50, interval = 100) {
        let attempts = 0;

        const checkLeaflet = setInterval(() => {
            attempts++;

            if (typeof L !== 'undefined') {
                clearInterval(checkLeaflet);
                console.log(`Leaflet carregado ap√≥s ${attempts} tentativa(s)`);
                callback();
            } else if (attempts >= maxAttempts) {
                clearInterval(checkLeaflet);
                console.error('Timeout: Leaflet n√£o carregou ap√≥s ' + (maxAttempts * interval / 1000) + ' segundos');
                const el = document.getElementById('map-localizacao');
                if (el) {
                    el.innerHTML = '<div class="alert alert-danger text-center m-3"><i class="fas fa-exclamation-triangle me-2"></i>Erro ao carregar biblioteca de mapas. <small class="d-block mt-1">Verifique sua conex√£o e recarregue a p√°gina.</small></div>';
                }
            }
        }, interval);
    }

    // CORRE√á√ÉO 11: Cleanup ao sair da p√°gina (evita memory leak)
    window.addEventListener('beforeunload', function() {
        if (mapInstance) {
            console.log('Limpando inst√¢ncia do mapa antes de sair da p√°gina...');
            mapInstance.remove();
            mapInstance = null;
        }
    });

    // Inicializar quando o DOM e o Leaflet estiverem prontos
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            waitForLeaflet(initMap);
        });
    } else {
        waitForLeaflet(initMap);
    }
})();
</script>

<style>
.mapa-localizacao-component .card {
    border-radius: 12px;
    overflow: hidden;
}

.mapa-localizacao-component .card-header {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-bottom: 1px solid #dee2e6;
    padding: 0.75rem 1rem;
}

/* CORRE√á√ÉO: Container do mapa com dimens√µes expl√≠citas e overflow controlado */
.mapa-localizacao-component .map-container {
    width: 100%;
    height: 350px;
    position: relative;
    overflow: hidden; /* Evita scroll interno */
    background-color: #f0f0f0; /* Cor de fundo enquanto carrega */
}

/* CORRE√á√ÉO: Garantir que o Leaflet container preencha todo o espa√ßo */
.mapa-localizacao-component .map-container .leaflet-container {
    width: 100% !important;
    height: 100% !important;
    position: absolute;
    top: 0;
    left: 0;
}

/* CORRE√á√ÉO: Estilo para popups customizados */
.leaflet-popup.custom-popup .leaflet-popup-content-wrapper {
    border-radius: 8px;
    box-shadow: 0 3px 14px rgba(0,0,0,0.2);
}

.leaflet-popup.custom-popup .leaflet-popup-content {
    margin: 12px 16px;
    line-height: 1.5;
}

.leaflet-popup.custom-popup .leaflet-popup-tip {
    box-shadow: 0 3px 14px rgba(0,0,0,0.1);
}

/* CORRE√á√ÉO: Melhorar visibilidade dos controles de zoom */
.mapa-localizacao-component .leaflet-control-zoom {
    border: 2px solid rgba(0,0,0,0.1);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.mapa-localizacao-component .leaflet-control-zoom a {
    font-size: 18px;
    line-height: 28px;
    color: #333;
}

.mapa-localizacao-component .leaflet-control-zoom a:hover {
    background-color: #f4f4f4;
}

/* CORRE√á√ÉO: Anima√ß√£o de loading suave */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.mapa-localizacao-component .map-container:empty::before {
    content: '';
    display: block;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: pulse 2s ease-in-out infinite;
}

/* Responsividade aprimorada */
@media (max-width: 992px) {
    .mapa-localizacao-component .map-container { height: 280px; }
}

@media (max-width: 768px) {
    .mapa-localizacao-component .map-container { height: 250px; }
    .mapa-localizacao-component .card-header { padding: 0.5rem 0.75rem; }

    /* Ajustar controles de zoom em mobile */
    .mapa-localizacao-component .leaflet-control-zoom a {
        width: 32px;
        height: 32px;
        line-height: 32px;
    }
}

@media (max-width: 576px) {
    .mapa-localizacao-component .map-container { height: 220px; }

    /* Popups mais compactos em telas pequenas */
    .leaflet-popup.custom-popup .leaflet-popup-content {
        margin: 8px 12px;
        font-size: 0.85rem;
    }
}

/* CORRE√á√ÉO: Acessibilidade - melhorar foco em elementos interativos */
.mapa-localizacao-component .leaflet-control-zoom a:focus {
    outline: 2px solid #007bff;
    outline-offset: 2px;
}

.mapa-localizacao-component .leaflet-marker-icon:focus {
    outline: 2px solid #007bff;
    outline-offset: 4px;
    border-radius: 50%;
}
</style>