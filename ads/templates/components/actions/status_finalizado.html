{# Componente de ações para status FINALIZADO #}
<div class="status-actions-container" data-status="finalizado">
  <div class="row g-3">
    
    {# Card principal para o cliente #}
    {% if user.is_authenticated and user == necessidade.cliente %}
    <div class="col-12">
      <div class="card border-success shadow-sm">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            <i class="fas fa-check-circle me-2"></i>
            Serviço Finalizado
          </h6>
        </div>
        <div class="card-body">
          {% with orcamento_confirmado=necessidade.get_confirmed_budget %}
          {% if orcamento_confirmado %}
          <div class="alert alert-success mb-3">
            <i class="fas fa-trophy me-1"></i>
            <strong>Parabéns!</strong> Negociação concluída com sucesso com <strong>{{ orcamento_confirmado.fornecedor.get_full_name }}</strong>
          </div>
          
          <div class="row text-center mb-3">
            <div class="col-4">
              <h5 class="text-success mb-1">R$ {{ orcamento_confirmado.valor_total|floatformat:2 }}</h5>
              <small class="text-muted">Valor final</small>
            </div>
            <div class="col-4">
              <h5 class="text-primary mb-1">
                {% if necessidade.data_finalizacao %}
                  {{ necessidade.data_finalizacao|date:"d/m/Y" }}
                {% else %}
                  Concluído
                {% endif %}
              </h5>
              <small class="text-muted">Data finalização</small>
            </div>
            <div class="col-4">
              <h5 class="text-info mb-1">
                {{ necessidade.orcamentos.count }}
              </h5>
              <small class="text-muted">Orçamentos recebidos</small>
            </div>
          </div>
          
          <div class="timeline-complete mb-3">
            <div class="timeline-item completed">
              <i class="fas fa-plus-circle"></i>
              <span>Anúncio criado</span>
            </div>
            <div class="timeline-item completed">
              <i class="fas fa-file-invoice-dollar"></i>
              <span>Orçamentos recebidos</span>
            </div>
            <div class="timeline-item completed">
              <i class="fas fa-handshake"></i>
              <span>Acordo fechado</span>
            </div>
            <div class="timeline-item completed">
              <i class="fas fa-cogs"></i>
              <span>Serviço executado</span>
            </div>
            <div class="timeline-item completed">
              <i class="fas fa-check-circle"></i>
              <span>Finalizado</span>
            </div>
          </div>
          
          {# Seção de avaliação #}
          {% if not avaliacao_cliente %}
          <div class="alert alert-warning mb-3">
            <i class="fas fa-star me-1"></i>
            <strong>Avalie o fornecedor!</strong> Sua opinião ajuda outros clientes a escolher melhor.
          </div>
          <a href="{% url 'avaliar_negociacao' necessidade.pk %}" 
             class="btn btn-warning w-100 mb-2"
             data-bs-toggle="modal"
             data-bs-target="#avaliacaoModal">
            <i class="fas fa-star me-2"></i>
            Avaliar Fornecedor
          </a>
          {% else %}
          <div class="alert alert-success mb-3">
            <i class="fas fa-check-circle me-1"></i>
            <strong>Obrigado pela avaliação!</strong> Você avaliou este fornecedor.
          </div>
          {% endif %}
          
          <div class="d-flex gap-2">
            <a href="{% url 'chat:iniciar_chat' necessidade.id %}" class="btn btn-outline-primary flex-fill">
              <i class="fas fa-comments me-1"></i>
              Histórico Chat
            </a>
            <a href="{% url 'budgets:budget_detail' orcamento_confirmado.id %}" 
               class="btn btn-outline-secondary flex-fill">
              <i class="fas fa-file-alt me-1"></i>
              Ver Contrato
            </a>
          </div>
          {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
    {% endif %}

    {# Card para o fornecedor que executou #}
    {% if user.is_authenticated and user != necessidade.cliente %}
    {% with orcamento_confirmado=necessidade.get_confirmed_budget %}
    {% if orcamento_confirmado and user == orcamento_confirmado.fornecedor %}
    <div class="col-12">
      <div class="card border-success shadow-sm">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            <i class="fas fa-trophy me-2"></i>
            Serviço Concluído
          </h6>
        </div>
        <div class="card-body">
          <div class="alert alert-success mb-3">
            <i class="fas fa-check-double me-1"></i>
            <strong>Parabéns!</strong> Você concluiu este serviço com sucesso!
          </div>
          
          <div class="row text-center mb-3">
            <div class="col-6">
              <h5 class="text-success mb-1">R$ {{ orcamento_confirmado.valor_total|floatformat:2 }}</h5>
              <small class="text-muted">Valor recebido</small>
            </div>
            <div class="col-6">
              <h5 class="text-primary mb-1">
                {% if necessidade.data_finalizacao %}
                  {{ necessidade.data_finalizacao|timesince }} atrás
                {% else %}
                  Recente
                {% endif %}
              </h5>
              <small class="text-muted">Finalizado</small>
            </div>
          </div>
          
          <div class="achievement-badge text-center mb-3">
            <i class="fas fa-medal fa-3x text-warning mb-2"></i>
            <p class="text-muted mb-0">Serviço executado com sucesso!</p>
          </div>
          
          {# Seção de avaliação #}
          {% if not avaliacao_fornecedor %}
          <div class="alert alert-warning mb-3">
            <i class="fas fa-star me-1"></i>
            <strong>Avalie o cliente!</strong> Ajude outros fornecedores a conhecer este cliente.
          </div>
          <a href="{% url 'avaliar_negociacao' necessidade.pk %}" 
             class="btn btn-warning w-100 mb-2"
             data-bs-toggle="modal"
             data-bs-target="#avaliacaoModal">
            <i class="fas fa-star me-2"></i>
            Avaliar Cliente
          </a>
          {% else %}
          <div class="alert alert-success mb-3">
            <i class="fas fa-check-circle me-1"></i>
            <strong>Obrigado pela avaliação!</strong> Você avaliou este cliente.
          </div>
          {% endif %}
          
          <div class="d-flex gap-2">
            <a href="{% url 'chat:iniciar_chat' necessidade.id %}" class="btn btn-outline-primary flex-fill">
              <i class="fas fa-comments me-1"></i>
              Histórico Chat
            </a>
            <a href="{% url 'budgets:budget_list' %}" class="btn btn-outline-success flex-fill">
              <i class="fas fa-list me-1"></i>
              Meus Orçamentos
            </a>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    {# Outros fornecedores #}
    <div class="col-12">
      <div class="card border-secondary shadow-sm">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0">
            <i class="fas fa-check-circle me-2"></i>
            Serviço Finalizado
          </h6>
        </div>
        <div class="card-body text-center">
          <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
          <p class="text-muted mb-2">
            Este anúncio foi finalizado com sucesso.
          </p>
          <small class="text-muted">
            A negociação foi concluída entre cliente e fornecedor.
          </small>
        </div>
      </div>
    </div>
    {% endif %}
    {% endwith %}
    {% endif %}

    {# Card para visitantes não logados #}
    {% if not user.is_authenticated %}
    <div class="col-12">
      <div class="card border-success shadow-sm">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            <i class="fas fa-check-circle me-2"></i>
            Serviço Concluído
          </h6>
        </div>
        <div class="card-body text-center">
          <i class="fas fa-trophy fa-2x text-success mb-2"></i>
          <p class="text-muted mb-3">
            Este anúncio foi finalizado com sucesso! A negociação foi concluída.
          </p>
          <div class="d-flex gap-2">
            <a href="{% url 'users:login' %}?next={{ request.path }}" 
               class="btn btn-success flex-fill">
              <i class="fas fa-sign-in-alt me-1"></i>
              Entrar
            </a>
            <a href="{% url 'users:register' %}" 
               class="btn btn-outline-success flex-fill">
              <i class="fas fa-user-plus me-1"></i>
              Cadastrar
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {# Card de estatísticas finais #}
    <div class="col-12">
      <div class="card bg-light border-0">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-4">
              <small class="text-muted d-block">Duração</small>
              <strong class="text-success">
                {% if necessidade.data_finalizacao and necessidade.data_criacao %}
                  {{ necessidade.data_criacao|timesince:necessidade.data_finalizacao }}
                {% else %}
                  -
                {% endif %}
              </strong>
            </div>
            <div class="col-4">
              <small class="text-muted d-block">Orçamentos</small>
              <strong class="text-primary">{{ necessidade.orcamentos.count }}</strong>
            </div>
            <div class="col-4">
              <small class="text-muted d-block">Status</small>
              <div class="d-flex align-items-center justify-content-center">
                <div class="status-indicator bg-success me-1"></div>
                <strong class="text-success">Concluído</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.timeline-complete {
  background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
  border-radius: 10px;
  padding: 1rem;
}

.timeline-complete .timeline-item {
  display: flex;
  align-items: center;
  padding: 0.5rem 0;
  color: #155724;
}

.timeline-complete .timeline-item i {
  width: 20px;
  margin-right: 0.75rem;
  color: #28a745;
}

.timeline-complete .timeline-item:not(:last-child) {
  border-bottom: 1px solid #c3e6cb;
}

.achievement-badge {
  background: linear-gradient(135deg, #fff3cd, #fef8e1);
  border-radius: 10px;
  padding: 1.5rem;
}

.status-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
}
</style>