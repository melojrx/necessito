<!-- Gr√°ficos 
Gr√°fico 1: Valores Movimentados por M√™s
Eixo X ‚Üí Meses (√∫ltimos 12 meses).
Eixo Y ‚Üí Soma dos valores dos an√∫ncios finalizados.

Insight esperado:
Identificar sazonalidade (ex.: picos em novembro/dezembro);
Verificar tend√™ncia de crescimento ou queda no uso da plataforma. 

Gr√°fico 2: Quantidade de An√∫ncios Finalizados por Categoria
Eixo X ‚Üí Categorias de produto/servi√ßo.
Eixo Y ‚Üí Quantidade de an√∫ncios finalizados.

Insight esperado:
Ver quais categorias geram mais neg√≥cios;
Encontrar nichos pouco explorados que mere√ßam campanhas.

Gr√°fico 3: Quantidade de usuarios dividido em clientes e fornecedores
Grafico de pizza, mostrando a propor√ß√£o de clientes e fornecedores na plataforma.
Eixo X ‚Üí Tipo de usu√°rio (Cliente ou Fornecedor).  

Gr√°fico 4: An√∫ncios Criados vs Finalizados
Eixo X ‚Üí Meses (√∫ltimos 12 meses).

Gr√°fico 4: Mapa de An√∫ncios por Localidade‚Äù
1. Estrutura recomendada:
‚úÖ O mapa vai substituir um dos gr√°ficos ou entrar abaixo dos 4 gr√°ficos (como sugerimos antes).
‚úÖ Exibe bolhas (circleMarkers) com:

Cidade/Estado
Quantidade de an√∫ncios
Tooltip ao passar o mouse

6. Insights que o mapa trar√°:
‚úÖ Visualizar distribui√ß√£o espacial da demanda;
‚úÖ Identificar cidades mais ativas;
‚úÖ Detectar oportunidades regionais (onde n√£o h√° an√∫ncios);
‚úÖ Planejar a√ß√µes locais de marketing ou suporte.

üéØ Resumo pr√°tico:
‚úîÔ∏è Use Leaflet.js + OpenStreetMap ‚Üí 100% open-source, leve, f√°cil;
‚úîÔ∏è Use Carto Dark Matter para tema escuro compat√≠vel;
‚úîÔ∏è Passe dados din√¢micos do Django via contexto JSON para JavaScript;
‚úîÔ∏è Integra direto no seu dashboard.html abaixo dos gr√°ficos ou substituindo algum.

-->

{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

{% include "components/_metrics_anuncios.html" %}
{% include "components/_metrics_valores.html" %}

<div class="row mt-4">
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Valores Movimentados por M√™s</h5>
          <canvas id="graficoValoresPorMes"></canvas>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoValoresPorMes')">Exportar PNG</button>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoValoresPorMes')">Exportar PDF</button>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">An√∫ncios Finalizados por Categoria</h5>
          <canvas id="graficoCategorias"></canvas>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoCategorias')">Exportar PNG</button>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoCategorias')">Exportar PDF</button>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Perfil de usuarios do Sistema</h5>
          <div style="height: 300px;">
            <canvas id="graficoUsuarios"></canvas>
          </div>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoUsuarios')">Exportar PNG</button>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoUsuarios')">Exportar PDF</button>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">An√∫ncios Criados vs Finalizados</h5>
          <canvas id="graficoAnuncios"></canvas>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoAnuncios')">Exportar PNG</button>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoAnuncios')">Exportar PDF</button>
        </div>
      </div>
    </div>
</div>

<!-- Modal com o mapa -->
<div class="modal fade" id="modalMapa" tabindex="-1" aria-labelledby="modalMapaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-location-dot"></i> Mapa de An√∫ncios por Localidade</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" style="height: 600px;">
          <div id="mapaAnuncios" style="height: 100%; width: 100%;"></div>
        </div>
      </div>
    </div>
</div>
  
<!-- Bot√£o para abrir o modal -->
<button type="button" class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#modalMapa">
  <i class="fas fa-map-marked-alt"></i> Ver Mapa de An√∫ncios
</button>
  

<!-- IMPORTA O jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Leaflet   -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Gr√°fico 1 -->
<script>
    const ctxValoresPorMes = document.getElementById('graficoValoresPorMes').getContext('2d');
    const graficoValoresPorMes = new Chart(ctxValoresPorMes, {
      type: 'bar',
      data: {
        labels: {{ grafico_valores_por_mes.labels|safe }},
        datasets: [{
          label: 'Valores Movimentados',
          data: {{ grafico_valores_por_mes.valores|safe }},
          backgroundColor: 'rgba(54, 162, 235, 0.7)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
</script>
  
<!-- Gr√°fico 2 -->
<script>
    const categoriasLabels = {{ grafico_categorias.labels|safe }};
    const categoriasData = {
        labels: categoriasLabels,
        datasets: [{
            label: 'An√∫ncios Finalizados por Categoria',
            backgroundColor: ['rgba(255, 99, 132, 0.6)','rgba(54, 162, 235, 0.6)','rgba(255, 206, 86, 0.6)','rgba(75, 192, 192, 0.6)','rgba(153, 102, 255, 0.6)','rgba(255, 159, 64, 0.6)'],
            borderColor: ['rgba(255,99,132,1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)'],
            borderWidth: 1,
            data: {{ grafico_categorias.valores|safe }},
        }]
    };
    const configCategorias = { type: 'bar', data: categoriasData, options: { indexAxis: 'x', scales: { y: { beginAtZero: true } } } };
    new Chart(document.getElementById('graficoCategorias'), configCategorias);
</script>

<!-- Gr√°fico 3 -->
<script>
    const usuariosData = {
        labels: {{ grafico_usuarios.labels|safe }},
        datasets: [{
            label: 'Usu√°rios por Tipo',
            data: {{ grafico_usuarios.valores|safe }},
            backgroundColor: ['rgba(54, 162, 235, 0.7)','rgba(255, 99, 132, 0.7)'],
            borderColor: ['rgba(54, 162, 235, 1)','rgba(255, 99, 132, 1)'],
            borderWidth: 1
        }]
    };
    const configUsuarios = { type: 'pie', data: usuariosData, options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { position: 'bottom' } } } };
    new Chart(document.getElementById('graficoUsuarios'), configUsuarios);
</script>

<!-- Gr√°fico 4 -->
<script>
    const anunciosData = {
        labels: {{ grafico_anuncios.labels|safe }},
        datasets: [
            { label: 'Criados', data: {{ grafico_anuncios.criados|safe }}, backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 },
            { label: 'Finalizados', data: {{ grafico_anuncios.finalizados|safe }}, backgroundColor: 'rgba(255, 99, 132, 0.7)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 }
        ]
    };
    const configAnuncios = { type: 'bar', data: anunciosData, options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'An√∫ncios Criados vs Finalizados' } }, scales: { x: { stacked: false }, y: { beginAtZero: true } } } };
    new Chart(document.getElementById('graficoAnuncios'), configAnuncios);
</script>

<script>
    // Torna a vari√°vel mapa global
    let mapa;

    document.addEventListener('DOMContentLoaded', function () {
        mapa = L.map('mapaAnuncios').setView([-5.203, -39.301], 7); // centro Cear√°

        // Tile layer tema claro
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a> contributors',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(mapa);

        const statusColors = {
            'ativo': '#28a745',        // verde
            'em_andamento': '#fd7e14', // laranja
            'em_atendimento': '#007bff', // azul
            'finalizado': '#6c757d',   // cinza
            'cancelado': '#dc3545'     // vermelho
        };

        // Fetch JSON dos an√∫ncios
        fetch("{% url 'anuncios_geolocalizados' %}")
    .then(response => response.json())
    .then(async anuncios => {
        for (const anuncio of anuncios) {
            let lat = anuncio.lat;
            let lon = anuncio.lon;

            // Se n√£o tiver lat/lon ‚Üí pedir geolocaliza√ß√£o via API interna
            if (lat === null || lon === null) {
                try {
                    const responseGeo = await fetch(`/api/geolocalizar-usuario/?user_id=${anuncio.cliente_id}`);
                    const dataGeo = await responseGeo.json();
                    if (dataGeo.lat && dataGeo.lon) {
                        lat = dataGeo.lat;
                        lon = dataGeo.lon;
                    } else {
                        // fallback
                        lat = -5.203;
                        lon = -39.301;
                    }
                } catch (error) {
                    console.error("Erro ao geocodificar:", error);
                    lat = -5.203;
                    lon = -39.301;
                }
            }

            const marker = L.circleMarker([lat, lon], {
                radius: 8,
                fillColor: statusColors[anuncio.status] || '#ffffff',
                color: '#000000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(mapa);

            marker.bindPopup(`
                <strong>${anuncio.titulo}</strong><br>
                ${anuncio.cidade}/${anuncio.estado}<br>
                Contato: <a href="mailto:${anuncio.email}">${anuncio.email}</a><br>
                Status: <span style="color:${statusColors[anuncio.status]}">${anuncio.status}</span><br>
                <a href="/necessidades/${anuncio.id}/" target="_blank">Ver detalhes</a>
            `);
        }
    });

        // Legenda
        const legenda = L.control({ position: 'bottomright' });
        legenda.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            const estados = Object.keys(statusColors);
            let legendaHTML = '<h6>Status</h6>';
            estados.forEach(status => {
                legendaHTML += `
                    <i style="background:${statusColors[status]}; width: 15px; height: 15px; display:inline-block; margin-right: 5px; border:1px solid #000;"></i> 
                    ${status}<br>
                `;
            });
            div.innerHTML = legendaHTML;
            return div;
        };
        legenda.addTo(mapa);
    });

    // Corrige o problema de tamanho ao abrir o modal
    const modalMapa = document.getElementById('modalMapa');
    modalMapa.addEventListener('shown.bs.modal', function () {
        mapa.invalidateSize();
    });
</script>

    
<script>
    const modalMapa = document.getElementById('modalMapa');
    modalMapa.addEventListener('shown.bs.modal', function () {
      mapa.invalidateSize();  // ‚Üê Aqui assume que a vari√°vel do mapa se chama 'mapa'
    });
</script>
      
<!-- FUN√á√ïES DE EXPORTA√á√ÉO -->
<script>
function exportChartAsImage(chartId) {
    const chartCanvas = document.getElementById(chartId);
    const imageURL = chartCanvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = imageURL;
    a.download = `${chartId}.png`;
    a.click();
}

function exportChartAsPDF(chartId) {
    const chartCanvas = document.getElementById(chartId);
    const imageURL = chartCanvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    const imgProps = pdf.getImageProperties(imageURL);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

    pdf.addImage(imageURL, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save(`${chartId}.pdf`);
}
</script>

<script>
    // Torna a vari√°vel mapa global
    let mapa;

    document.addEventListener('DOMContentLoaded', function () {
        // Inicializa o mapa no centro do Cear√°
        mapa = L.map('mapaAnuncios').setView([-5.203, -39.301], 7);

        // Adiciona o tile layer tema claro
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a> contributors',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(mapa);

        // Define as cores por status
        const statusColors = {
            'ativo': '#28a745',        // verde
            'em_andamento': '#fd7e14', // laranja
            'em_atendimento': '#007bff', // azul
            'finalizado': '#6c757d',   // cinza
            'cancelado': '#dc3545'     // vermelho
        };

        // Cria o grupo de clusters
        const clusterGroup = L.markerClusterGroup();

        // Busca os an√∫ncios via JSON
        fetch("{% url 'anuncios_geolocalizados' %}")
            .then(response => response.json())
            .then(anuncios => {
                anuncios.forEach(anuncio => {
                    // Adiciona um pequeno deslocamento para n√£o sobrepor pontos id√™nticos
                    const offsetLat = (Math.random() - 0.5) * 0.002;
                    const offsetLon = (Math.random() - 0.5) * 0.002;

                    // Cria o marcador
                    const marker = L.circleMarker([anuncio.lat + offsetLat, anuncio.lon + offsetLon], {
                        radius: 8,
                        fillColor: statusColors[anuncio.status] || '#ffffff',
                        color: '#000000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });

                    // Popup com os dados
                    marker.bindPopup(`
                        <strong>${anuncio.titulo}</strong><br>
                        ${anuncio.cidade}/${anuncio.estado}<br>
                        Status: <span style="color:${statusColors[anuncio.status]}">${anuncio.status}</span><br>
                        <a href="/necessidades/${anuncio.id}/" target="_blank">Ver detalhes</a>
                    `);

                    // Adiciona o marcador ao cluster
                    clusterGroup.addLayer(marker);
                });

                // Adiciona o cluster no mapa
                mapa.addLayer(clusterGroup);
            });

        // Cria a legenda
        const legenda = L.control({ position: 'bottomright' });
        legenda.onAdd = function () {
            const div = L.DomUtil.create('div', 'info legend');
            const statusKeys = Object.keys(statusColors);
            let legendaHTML = '<h6>Status</h6>';
            statusKeys.forEach(status => {
                legendaHTML += `
                    <i style="background:${statusColors[status]}; width: 15px; height: 15px; display:inline-block; margin-right: 5px; border:1px solid #000;"></i> 
                    ${status}<br>
                `;
            });
            div.innerHTML = legendaHTML;
            return div;
        };
        legenda.addTo(mapa);
    });

    // Corrige o tamanho do mapa ao abrir o modal
    const modalMapa = document.getElementById('modalMapa');
    modalMapa.addEventListener('shown.bs.modal', function () {
        mapa.invalidateSize();
    });
</script>


{% endblock %}
