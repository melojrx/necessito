<!-- Gr√°ficos 
Gr√°fico 1: Valores Movimentados por M√™s
Eixo X ‚Üí Meses (√∫ltimos 12 meses).
Eixo Y ‚Üí Soma dos valores dos an√∫ncios finalizados.

Insight esperado:
Identificar sazonalidade (ex.: picos em novembro/dezembro);
Verificar tend√™ncia de crescimento ou queda no uso da plataforma. 

Gr√°fico 2: Quantidade de An√∫ncios Finalizados por Categoria
Eixo X ‚Üí Categorias de produto/servi√ßo.
Eixo Y ‚Üí Quantidade de an√∫ncios finalizados.

Insight esperado:
Ver quais categorias geram mais neg√≥cios;
Encontrar nichos pouco explorados que mere√ßam campanhas.

Gr√°fico 3: Quantidade de usuarios dividido em clientes e fornecedores
Grafico de pizza, mostrando a propor√ß√£o de clientes e fornecedores na plataforma.
Eixo X ‚Üí Tipo de usu√°rio (Cliente ou Fornecedor).  

Gr√°fico 4: An√∫ncios Criados vs Finalizados
Eixo X ‚Üí Meses (√∫ltimos 12 meses).

Gr√°fico 4: Mapa de An√∫ncios por Localidade"
1. Estrutura recomendada:
‚úÖ O mapa vai substituir um dos gr√°ficos ou entrar abaixo dos 4 gr√°ficos (como sugerimos antes).
‚úÖ Exibe bolhas (circleMarkers) com:

Cidade/Estado
Quantidade de an√∫ncios
Tooltip ao passar o mouse

6. Insights que o mapa trar√°:
‚úÖ Visualizar distribui√ß√£o espacial da demanda;
‚úÖ Identificar cidades mais ativas;
‚úÖ Detectar oportunidades regionais (onde n√£o h√° an√∫ncios);
‚úÖ Planejar a√ß√µes locais de marketing ou suporte.

üéØ Resumo pr√°tico:
‚úîÔ∏è Use Leaflet.js + OpenStreetMap ‚Üí 100% open-source, leve, f√°cil;
‚úîÔ∏è Use Carto Dark Matter para tema escuro compat√≠vel;
‚úîÔ∏è Passe dados din√¢micos do Django via contexto JSON para JavaScript;
‚úîÔ∏è Integra direto no seu dashboard.html abaixo dos gr√°ficos ou substituindo algum.

-->

{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

{% include "components/_metrics_anuncios.html" %}
{% include "components/_metrics_valores.html" %}

<div class="row g-4 mt-4">
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Valores Movimentados por M√™s</h5>
          <canvas id="graficoValoresPorMes"></canvas>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoValoresPorMes')">Exportar PNG</button>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoValoresPorMes')">Exportar PDF</button>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">An√∫ncios Finalizados por Categoria</h5>
          <div class="flex-grow-1" style="position: relative; height: 350px;">
            <canvas id="graficoCategorias"></canvas>
          </div>
          <div class="mt-auto text-center">
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoCategorias')">Exportar PNG</button>
            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoCategorias')">Exportar PDF</button>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Perfil de usu√°rios do Sistema</h5>
          <div id="resumoUsuarios" class="mb-3"></div>
          <div class="flex-grow-1" style="position: relative; height: 300px;">
            <canvas id="graficoUsuarios"></canvas>
          </div>
          <div class="mt-auto text-center">
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoUsuarios')">Exportar PNG</button>
            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoUsuarios')">Exportar PDF</button>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">An√∫ncios Criados vs Finalizados</h5>
          <canvas id="graficoAnuncios"></canvas>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoAnuncios')">Exportar PNG</button>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoAnuncios')">Exportar PDF</button>
        </div>
      </div>
    </div>
</div>

<!-- Modal com o mapa -->
<div class="modal fade" id="modalMapa" tabindex="-1" aria-labelledby="modalMapaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-location-dot"></i> Mapa de An√∫ncios por Localidade</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" style="height: 600px;">
          <div id="mapaAnuncios" style="height: 100%; width: 100%;"></div>
        </div>
      </div>
    </div>
</div>
  
<!-- Bot√£o para abrir o modal -->
<div class="mb-4 mt-4">
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalMapa">
  <i class="fas fa-map-marked-alt"></i> Ver Mapa de An√∫ncios
</button>
</div>
  

<!-- Dados do Django para JavaScript usando json_script -->
{{ grafico_valores_por_mes|json_script:"grafico-valores-data" }}
{{ grafico_categorias|json_script:"grafico-categorias-data" }}
{{ grafico_usuarios|json_script:"grafico-usuarios-data" }}
{{ grafico_anuncios|json_script:"grafico-anuncios-data" }}

<!-- IMPORTA O jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- IMPORTA O Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script> <!-- Garante que Chart.js seja carregado primeiro -->
<!-- IMPORTA O plugin de datalabels para Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
<!-- Leaflet CSS j√° est√° importado no base.html -->

<script>
document.addEventListener('DOMContentLoaded', function () {
  // O plugin datalabels deve se auto-registrar com Chart.js v4 se carregado corretamente ap√≥s o Chart.js
  // Remover o Chart.register(ChartDataLabels) expl√≠cito pode resolver conflitos em alguns casos.

  console.log('Dashboard - Iniciando carregamento dos gr√°ficos e mapa...');

  // Recuperar dados do Django de forma segura
  const valoresData = JSON.parse(document.getElementById('grafico-valores-data').textContent);
  const categoriasData = JSON.parse(document.getElementById('grafico-categorias-data').textContent);
  const usuariosData = JSON.parse(document.getElementById('grafico-usuarios-data').textContent);
  const anunciosData = JSON.parse(document.getElementById('grafico-anuncios-data').textContent);

  // GR√ÅFICOS
  try {
    // Gr√°fico 1 - Valores por M√™s
    const ctxValoresPorMes = document.getElementById('graficoValoresPorMes');
    if (ctxValoresPorMes && valoresData.labels && valoresData.labels.length > 0) {
      const graficoValoresPorMes = new Chart(ctxValoresPorMes.getContext('2d'), {
        type: 'bar',
        data: {
          labels: valoresData.labels,
          datasets: [{
            label: 'Valores Movimentados',
            data: valoresData.valores,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      console.log('Gr√°fico 1 carregado com sucesso');
    }
  } catch (error) {
    console.error('Erro ao carregar Gr√°fico 1:', error);
  }

  try {
    // Gr√°fico 2 - Categorias (Barras horizontais)
    const ctxCategorias = document.getElementById('graficoCategorias');
    console.log('Dados para Gr√°fico Categorias:', categoriasData); // Log para depura√ß√£o

    if (ctxCategorias) { // Verifica se o canvas existe
      if (categoriasData && categoriasData.labels && categoriasData.labels.length > 0 && categoriasData.valores && categoriasData.valores.length > 0) {
        // C√°lculo dos percentuais
        const total = categoriasData.valores.reduce((a, b) => a + b, 0);
        const percentuais = categoriasData.valores.map(v => total > 0 ? (v / total * 100) : 0);

        // Paleta de cores acess√≠vel
        const cores = [
          '#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f',
          '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'
        ];

        const graficoCategorias = new Chart(ctxCategorias.getContext('2d'), {
          type: 'bar',
          data: {
            labels: categoriasData.labels,
            datasets: [{
              label: 'An√∫ncios Finalizados',
              data: categoriasData.valores,
              backgroundColor: cores,
              borderColor: cores,
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y', // Barras horizontais
            responsive: true,
            maintainAspectRatio: false, // Importante para controlar a altura via div container
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed.x;
                    const percent = percentuais[context.dataIndex];
                    return `${context.label}: ${value} (${percent.toFixed(1)}%)`;
                  }
                }
              },
              title: {
                display: true,
                text: 'An√∫ncios Finalizados por Categoria'
              },
              datalabels: { // Configura√ß√£o do plugin datalabels
                anchor: 'end',
                align: 'end',
                color: '#333',
                font: { 
                  weight: 'bold',
                  size: 10
                },
                formatter: function(value, context) {
                  return `${value} (${percentuais[context.dataIndex].toFixed(1)}%)`;
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                title: { display: true, text: 'Quantidade' }
              },
              y: {
                title: { display: false }
              }
            }
          }
        });
        console.log('Gr√°fico 2 carregado com sucesso');
      } else {
        // Exibir mensagem de "sem dados"
        const context = ctxCategorias.getContext('2d');
        context.textAlign = 'center';
        context.textBaseline = 'middle';
        context.font = "16px Arial";
        context.fillText('Nenhum dado para exibir neste gr√°fico.', ctxCategorias.width / 2, ctxCategorias.height / 2);
        console.log('Gr√°fico 2: Nenhum dado para exibir.');
      }
    } else {
      console.error('Elemento canvas #graficoCategorias n√£o encontrado.');
    }
  } catch (error) {
    console.error('Erro ao carregar Gr√°fico 2:', error);
  }

  try {
    // Gr√°fico 3 - Usu√°rios (Pizza)
    const ctxUsuarios = document.getElementById('graficoUsuarios');
    if (ctxUsuarios && usuariosData.labels && usuariosData.labels.length > 0) {
      // C√°lculo dos percentuais
      const totalUsuarios = usuariosData.total || usuariosData.valores.reduce((a, b) => a + b, 0);
      const percentuais = usuariosData.valores.map(v => totalUsuarios > 0 ? (v / totalUsuarios * 100) : 0);
      // Resumo visual acima do gr√°fico
      let resumoHTML = `<div class='d-flex flex-wrap gap-3 align-items-center justify-content-center'>`;
      resumoHTML += `<span class='badge bg-primary fs-6'>Total: <strong>${totalUsuarios}</strong> usu√°rios</span>`;
      usuariosData.labels.forEach((label, idx) => {
        const cor = [
          'bg-info',
          'bg-danger',
          'bg-success',
          'bg-secondary'
        ][idx] || 'bg-secondary';
        resumoHTML += `<span class='badge ${cor} fs-6'>${label}: <strong>${usuariosData.valores[idx]}</strong> (${percentuais[idx].toFixed(1)}%)</span>`;
      });
      resumoHTML += `</div>`;
      document.getElementById('resumoUsuarios').innerHTML = resumoHTML;

      // Cores acess√≠veis e distintas
      const cores = [
        'rgba(54, 162, 235, 0.7)', // S√≥ Clientes
        'rgba(255, 99, 132, 0.7)', // S√≥ Fornecedores
        'rgba(75, 192, 192, 0.7)', // Ambos
        'rgba(201, 203, 207, 0.7)' // Nenhum
      ];
      const bordas = [
        'rgba(54, 162, 235, 1)',
        'rgba(255, 99, 132, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(201, 203, 207, 1)'
      ];
      const graficoUsuarios = new Chart(ctxUsuarios.getContext('2d'), {
        type: 'pie',
        data: {
          labels: usuariosData.labels,
          datasets: [{
            label: 'Usu√°rios por Tipo',
            data: usuariosData.valores,
            backgroundColor: cores,
            borderColor: bordas,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { size: 14 },
                generateLabels: function(chart) {
                  const data = chart.data;
                  const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                  return data.labels.map((label, i) => {
                    const value = data.datasets[0].data[i];
                    const percent = total > 0 ? (value / total * 100) : 0;
                    return {
                      text: `${label} (${percent.toFixed(1)}%)`,
                      fillStyle: data.datasets[0].backgroundColor[i],
                      strokeStyle: data.datasets[0].borderColor[i],
                      lineWidth: 1,
                      hidden: isNaN(data.datasets[0].data[i]) || chart.getDataVisibility(i) === false,
                      index: i
                    };
                  });
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percent = total > 0 ? (value / total * 100) : 0;
                  return `${label}: ${value} (${percent.toFixed(1)}%)`;
                }
              }
            }
          }
        }
      });
      console.log('Gr√°fico 3 carregado com sucesso');
    }
  } catch (error) {
    console.error('Erro ao carregar Gr√°fico 3:', error);
  }

  try {
    // Gr√°fico 4 - An√∫ncios Criados vs Finalizados
    const ctxAnuncios = document.getElementById('graficoAnuncios');
    if (ctxAnuncios && anunciosData.labels && anunciosData.labels.length > 0) {
      const graficoAnuncios = new Chart(ctxAnuncios.getContext('2d'), {
        type: 'bar',
        data: {
          labels: anunciosData.labels,
          datasets: [
            {
              label: 'Criados',
              data: anunciosData.criados,
              backgroundColor: 'rgba(54, 162, 235, 0.7)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            },
            {
              label: 'Finalizados',
              data: anunciosData.finalizados,
              backgroundColor: 'rgba(255, 99, 132, 0.7)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top'
            },
            title: {
              display: true,
              text: 'An√∫ncios Criados vs Finalizados'
            }
          },
          scales: {
            x: {
              stacked: false
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });
      console.log('Gr√°fico 4 carregado com sucesso');
    }
  } catch (error) {
    console.error('Erro ao carregar Gr√°fico 4:', error);
  }

  // MAPA
  let mapa;
  
  // Fun√ß√£o para inicializar o mapa quando o modal for aberto
  function initializeMapa() {
    if (mapa) {
      // Se o mapa j√° existe, apenas redimensiona
      mapa.invalidateSize();
      return;
    }

    try {
      const mapaContainer = document.getElementById('mapaAnuncios');
      if (!mapaContainer) {
        console.error('Container do mapa n√£o encontrado');
        return;
      }

      mapa = L.map('mapaAnuncios').setView([-5.203, -39.301], 7);
      
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CARTO</a> contributors',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(mapa);

      const statusColors = {
        'ativo': '#28a745',
        'em_andamento': '#fd7e14',
        'em_atendimento': '#007bff',
        'finalizado': '#6c757d',
        'cancelado': '#dc3545'
      };

      // Buscar an√∫ncios geolocalizados
      fetch("{% url 'anuncios_geolocalizados' %}")
        .then(response => response.json())
        .then(async anuncios => {
          console.log(`Carregando ${anuncios.length} an√∫ncios no mapa...`);
          
          for (const anuncio of anuncios) {
            let lat = anuncio.lat;
            let lon = anuncio.lon;
            
            if (lat === null || lon === null) {
              try {
                const responseGeo = await fetch(`/api/geolocalizar-usuario/?user_id=${anuncio.cliente_id}`);
                const dataGeo = await responseGeo.json();
                if (dataGeo.lat && dataGeo.lon) {
                  lat = dataGeo.lat;
                  lon = dataGeo.lon;
                } else {
                  lat = -5.203;
                  lon = -39.301;
                }
              } catch (error) {
                console.error("Erro ao geocodificar:", error);
                lat = -5.203;
                lon = -39.301;
              }
            }
            
            const marker = L.circleMarker([lat, lon], {
              radius: 8,
              fillColor: statusColors[anuncio.status] || '#ffffff',
              color: '#000000',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(mapa);
            
            marker.bindPopup(`
              <strong>${anuncio.titulo}</strong><br>
              ${anuncio.cidade}/${anuncio.estado}<br>
              Status: <span style="color:${statusColors[anuncio.status]}">${anuncio.status}</span><br>
              <a href="/necessidades/${anuncio.id}/" target="_blank">Ver detalhes</a>
            `);
          }
        })
        .catch(error => {
          console.error('Erro ao carregar an√∫ncios:', error);
        });

      // Adicionar legenda
      const legenda = L.control({ position: 'bottomright' });
      legenda.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        const estados = Object.keys(statusColors);
        let legendaHTML = '<h6>Status</h6>';
        estados.forEach(status => {
          legendaHTML += `
            <i style="background:${statusColors[status]}; width: 15px; height: 15px; display:inline-block; margin-right: 5px; border:1px solid #000;"></i> 
            ${status}<br>
          `;
        });
        div.innerHTML = legendaHTML;
        
        // Estilo da legenda
        div.style.backgroundColor = 'white';
        div.style.padding = '10px';
        div.style.borderRadius = '5px';
        div.style.boxShadow = '0 1px 5px rgba(0,0,0,0.4)';
        
        return div;
      };
      legenda.addTo(mapa);
      
      console.log('Mapa carregado com sucesso');
    } catch (error) {
      console.error('Erro ao carregar mapa:', error);
    }
  }

  // Configurar o modal do mapa
  const modalMapa = document.getElementById('modalMapa');
  if (modalMapa) {
    modalMapa.addEventListener('shown.bs.modal', function () {
      console.log('Modal do mapa aberto, inicializando mapa...');
      initializeMapa();
    });
  }
});
</script>

<!-- FUN√á√ïES DE EXPORTA√á√ÉO -->
<script>
function exportChartAsImage(chartId) {
    const chartCanvas = document.getElementById(chartId);
    const imageURL = chartCanvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = imageURL;
    a.download = `${chartId}.png`;
    a.click();
}

function exportChartAsPDF(chartId) {
    const chartCanvas = document.getElementById(chartId);
    const imageURL = chartCanvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    const imgProps = pdf.getImageProperties(imageURL);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

    pdf.addImage(imageURL, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save(`${chartId}.pdf`);
}
</script>

{% endblock %}
