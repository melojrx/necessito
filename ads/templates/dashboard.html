<!-- Gr√°ficos 
Gr√°fico 1: Valores Movimentados por M√™s
Eixo X ‚Üí Meses (√∫ltimos 12 meses).
Eixo Y ‚Üí Soma dos valores dos an√∫ncios finalizados.

Insight esperado:
Identificar sazonalidade (ex.: picos em novembro/dezembro);
Verificar tend√™ncia de crescimento ou queda no uso da plataforma. 

Gr√°fico 2: Quantidade de An√∫ncios Finalizados por Categoria
Eixo X ‚Üí Categorias de produto/servi√ßo.
Eixo Y ‚Üí Quantidade de an√∫ncios finalizados.

Insight esperado:
Ver quais categorias geram mais neg√≥cios;
Encontrar nichos pouco explorados que mere√ßam campanhas.

Gr√°fico 3: Quantidade de usuarios dividido em clientes e fornecedores
Grafico de pizza, mostrando a propor√ß√£o de clientes e fornecedores na plataforma.
Eixo X ‚Üí Tipo de usu√°rio (Cliente ou Fornecedor).  

Gr√°fico 4: An√∫ncios Criados vs Finalizados
Eixo X ‚Üí Meses (√∫ltimos 12 meses).

Gr√°fico 4: Mapa de An√∫ncios por Localidade"
1. Estrutura recomendada:
‚úÖ O mapa vai substituir um dos gr√°ficos ou entrar abaixo dos 4 gr√°ficos (como sugerimos antes).
‚úÖ Exibe bolhas (circleMarkers) com:

Cidade/Estado
Quantidade de an√∫ncios
Tooltip ao passar o mouse

6. Insights que o mapa trar√°:
‚úÖ Visualizar distribui√ß√£o espacial da demanda;
‚úÖ Identificar cidades mais ativas;
‚úÖ Detectar oportunidades regionais (onde n√£o h√° an√∫ncios);
‚úÖ Planejar a√ß√µes locais de marketing ou suporte.

üéØ Resumo pr√°tico:
‚úîÔ∏è Use Leaflet.js + OpenStreetMap ‚Üí 100% open-source, leve, f√°cil;
‚úîÔ∏è Use Carto Dark Matter para tema escuro compat√≠vel;
‚úîÔ∏è Passe dados din√¢micos do Django via contexto JSON para JavaScript;
‚úîÔ∏è Integra direto no seu dashboard.html abaixo dos gr√°ficos ou substituindo algum.

-->

{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

{% include "components/_metrics_anuncios.html" %}
{% include "components/_metrics_valores.html" %}

<div class="row g-4 mt-4">
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Valores Movimentados por M√™s</h5>
          <canvas id="graficoValoresPorMes"></canvas>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoValoresPorMes')">Exportar PNG</button>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoValoresPorMes')">Exportar PDF</button>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">An√∫ncios Finalizados por Categoria</h5>
          <canvas id="graficoCategorias"></canvas>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoCategorias')">Exportar PNG</button>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoCategorias')">Exportar PDF</button>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Perfil de usu√°rios do Sistema</h5>
          <div style="height: 300px;">
            <canvas id="graficoUsuarios"></canvas>
          </div>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoUsuarios')">Exportar PNG</button>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoUsuarios')">Exportar PDF</button>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">An√∫ncios Criados vs Finalizados</h5>
          <canvas id="graficoAnuncios"></canvas>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="exportChartAsImage('graficoAnuncios')">Exportar PNG</button>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="exportChartAsPDF('graficoAnuncios')">Exportar PDF</button>
        </div>
      </div>
    </div>
</div>

<!-- Modal com o mapa -->
<div class="modal fade" id="modalMapa" tabindex="-1" aria-labelledby="modalMapaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-location-dot"></i> Mapa de An√∫ncios por Localidade</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" style="height: 600px;">
          <div id="mapaAnuncios" style="height: 100%; width: 100%;"></div>
        </div>
      </div>
    </div>
</div>
  
<!-- Bot√£o para abrir o modal -->
<div class="mb-4 mt-4">
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalMapa">
  <i class="fas fa-map-marked-alt"></i> Ver Mapa de An√∫ncios
</button>
</div>
  

<!-- Dados do Django para JavaScript usando json_script -->
{{ grafico_valores_por_mes|json_script:"grafico-valores-data" }}
{{ grafico_categorias|json_script:"grafico-categorias-data" }}
{{ grafico_usuarios|json_script:"grafico-usuarios-data" }}
{{ grafico_anuncios|json_script:"grafico-anuncios-data" }}

<!-- IMPORTA O jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Leaflet CSS j√° est√° importado no base.html -->

<script>
document.addEventListener('DOMContentLoaded', function () {
  console.log('Dashboard - Iniciando carregamento dos gr√°ficos e mapa...');

  // Recuperar dados do Django de forma segura
  const valoresData = JSON.parse(document.getElementById('grafico-valores-data').textContent);
  const categoriasData = JSON.parse(document.getElementById('grafico-categorias-data').textContent);
  const usuariosData = JSON.parse(document.getElementById('grafico-usuarios-data').textContent);
  const anunciosData = JSON.parse(document.getElementById('grafico-anuncios-data').textContent);

  // GR√ÅFICOS
  try {
    // Gr√°fico 1 - Valores por M√™s
    const ctxValoresPorMes = document.getElementById('graficoValoresPorMes');
    if (ctxValoresPorMes && valoresData.labels && valoresData.labels.length > 0) {
      const graficoValoresPorMes = new Chart(ctxValoresPorMes.getContext('2d'), {
        type: 'bar',
        data: {
          labels: valoresData.labels,
          datasets: [{
            label: 'Valores Movimentados',
            data: valoresData.valores,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      console.log('Gr√°fico 1 carregado com sucesso');
    }
  } catch (error) {
    console.error('Erro ao carregar Gr√°fico 1:', error);
  }

  try {
    // Gr√°fico 2 - Categorias
    const ctxCategorias = document.getElementById('graficoCategorias');
    if (ctxCategorias && categoriasData.labels && categoriasData.labels.length > 0) {
      const graficoCategorias = new Chart(ctxCategorias.getContext('2d'), {
        type: 'bar',
        data: {
          labels: categoriasData.labels,
          datasets: [{
            label: 'An√∫ncios Finalizados por Categoria',
            data: categoriasData.valores,
            backgroundColor: [
              'rgba(255, 99, 132, 0.6)',
              'rgba(54, 162, 235, 0.6)',
              'rgba(255, 206, 86, 0.6)',
              'rgba(75, 192, 192, 0.6)',
              'rgba(153, 102, 255, 0.6)',
              'rgba(255, 159, 64, 0.6)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      console.log('Gr√°fico 2 carregado com sucesso');
    }
  } catch (error) {
    console.error('Erro ao carregar Gr√°fico 2:', error);
  }

  try {
    // Gr√°fico 3 - Usu√°rios (Pizza)
    const ctxUsuarios = document.getElementById('graficoUsuarios');
    if (ctxUsuarios && usuariosData.labels && usuariosData.labels.length > 0) {
      const graficoUsuarios = new Chart(ctxUsuarios.getContext('2d'), {
        type: 'pie',
        data: {
          labels: usuariosData.labels,
          datasets: [{
            label: 'Usu√°rios por Tipo',
            data: usuariosData.valores,
            backgroundColor: [
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 99, 132, 0.7)'
            ],
            borderColor: [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
      console.log('Gr√°fico 3 carregado com sucesso');
    }
  } catch (error) {
    console.error('Erro ao carregar Gr√°fico 3:', error);
  }

  try {
    // Gr√°fico 4 - An√∫ncios Criados vs Finalizados
    const ctxAnuncios = document.getElementById('graficoAnuncios');
    if (ctxAnuncios && anunciosData.labels && anunciosData.labels.length > 0) {
      const graficoAnuncios = new Chart(ctxAnuncios.getContext('2d'), {
        type: 'bar',
        data: {
          labels: anunciosData.labels,
          datasets: [
            {
              label: 'Criados',
              data: anunciosData.criados,
              backgroundColor: 'rgba(54, 162, 235, 0.7)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            },
            {
              label: 'Finalizados',
              data: anunciosData.finalizados,
              backgroundColor: 'rgba(255, 99, 132, 0.7)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top'
            },
            title: {
              display: true,
              text: 'An√∫ncios Criados vs Finalizados'
            }
          },
          scales: {
            x: {
              stacked: false
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });
      console.log('Gr√°fico 4 carregado com sucesso');
    }
  } catch (error) {
    console.error('Erro ao carregar Gr√°fico 4:', error);
  }

  // MAPA
  let mapa;
  
  // Fun√ß√£o para inicializar o mapa quando o modal for aberto
  function initializeMapa() {
    if (mapa) {
      // Se o mapa j√° existe, apenas redimensiona
      mapa.invalidateSize();
      return;
    }

    try {
      const mapaContainer = document.getElementById('mapaAnuncios');
      if (!mapaContainer) {
        console.error('Container do mapa n√£o encontrado');
        return;
      }

      mapa = L.map('mapaAnuncios').setView([-5.203, -39.301], 7);
      
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CARTO</a> contributors',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(mapa);

      const statusColors = {
        'ativo': '#28a745',
        'em_andamento': '#fd7e14',
        'em_atendimento': '#007bff',
        'finalizado': '#6c757d',
        'cancelado': '#dc3545'
      };

      // Buscar an√∫ncios geolocalizados
      fetch("{% url 'anuncios_geolocalizados' %}")
        .then(response => response.json())
        .then(async anuncios => {
          console.log(`Carregando ${anuncios.length} an√∫ncios no mapa...`);
          
          for (const anuncio of anuncios) {
            let lat = anuncio.lat;
            let lon = anuncio.lon;
            
            if (lat === null || lon === null) {
              try {
                const responseGeo = await fetch(`/api/geolocalizar-usuario/?user_id=${anuncio.cliente_id}`);
                const dataGeo = await responseGeo.json();
                if (dataGeo.lat && dataGeo.lon) {
                  lat = dataGeo.lat;
                  lon = dataGeo.lon;
                } else {
                  lat = -5.203;
                  lon = -39.301;
                }
              } catch (error) {
                console.error("Erro ao geocodificar:", error);
                lat = -5.203;
                lon = -39.301;
              }
            }
            
            const marker = L.circleMarker([lat, lon], {
              radius: 8,
              fillColor: statusColors[anuncio.status] || '#ffffff',
              color: '#000000',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(mapa);
            
            marker.bindPopup(`
              <strong>${anuncio.titulo}</strong><br>
              ${anuncio.cidade}/${anuncio.estado}<br>
              Status: <span style="color:${statusColors[anuncio.status]}">${anuncio.status}</span><br>
              <a href="/necessidades/${anuncio.id}/" target="_blank">Ver detalhes</a>
            `);
          }
        })
        .catch(error => {
          console.error('Erro ao carregar an√∫ncios:', error);
        });

      // Adicionar legenda
      const legenda = L.control({ position: 'bottomright' });
      legenda.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        const estados = Object.keys(statusColors);
        let legendaHTML = '<h6>Status</h6>';
        estados.forEach(status => {
          legendaHTML += `
            <i style="background:${statusColors[status]}; width: 15px; height: 15px; display:inline-block; margin-right: 5px; border:1px solid #000;"></i> 
            ${status}<br>
          `;
        });
        div.innerHTML = legendaHTML;
        
        // Estilo da legenda
        div.style.backgroundColor = 'white';
        div.style.padding = '10px';
        div.style.borderRadius = '5px';
        div.style.boxShadow = '0 1px 5px rgba(0,0,0,0.4)';
        
        return div;
      };
      legenda.addTo(mapa);
      
      console.log('Mapa carregado com sucesso');
    } catch (error) {
      console.error('Erro ao carregar mapa:', error);
    }
  }

  // Configurar o modal do mapa
  const modalMapa = document.getElementById('modalMapa');
  if (modalMapa) {
    modalMapa.addEventListener('shown.bs.modal', function () {
      console.log('Modal do mapa aberto, inicializando mapa...');
      initializeMapa();
    });
  }
});
</script>

<!-- FUN√á√ïES DE EXPORTA√á√ÉO -->
<script>
function exportChartAsImage(chartId) {
    const chartCanvas = document.getElementById(chartId);
    const imageURL = chartCanvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = imageURL;
    a.download = `${chartId}.png`;
    a.click();
}

function exportChartAsPDF(chartId) {
    const chartCanvas = document.getElementById(chartId);
    const imageURL = chartCanvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    const imgProps = pdf.getImageProperties(imageURL);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

    pdf.addImage(imageURL, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save(`${chartId}.pdf`);
}
</script>

{% endblock %}
