{% extends 'base.html' %}

{% load custom_filters %}

{% block title %}Detalhes da Necessidade{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Coluna Esquerda: Detalhes da Necessidade -->
        <div class="col-md-8 mb-2">
            <h2>{{ necessidade.titulo }}</h2>
            <p><strong>Publicado em:</strong> {{ necessidade.data_criacao }}</p>
            <p><strong>Categoria:</strong> {{ necessidade.categoria.nome }}</p>
            <p><strong>Subcategoria:</strong> {{ necessidade.subcategoria.nome }}</p>
            <p><strong>Quantidade:</strong> {{ necessidade.quantidade }} </p>
            <p><strong>Unidade:</strong> {{ necessidade.unidade }}</p>
            <p><strong>Descrição:</strong> {{ necessidade.descricao }}</p>
            <div class="d-flex align-items-centermb-3">
                {% if user == necessidade.cliente %}
                <a href="{% url 'necessidade_update' necessidade.pk %}" class="btn btn-warning me-2">Editar</a>
                <a href="{% url 'necessidade_delete' necessidade.pk %}" class="btn btn-danger me-2">Excluir</a>
                {% endif %}

                <!-- Avaliação
                {% if user == necessidade.cliente or user == fornecedor %}
                <form action="{% url 'avaliar_negociacao' necessidade.pk %}" method="post" class="d-inline ms-auto">
                    {% csrf_token %}
                    <label for="estrelas" class="form-label me-2">Avalie este anúncio:</label>
                    <select name="estrelas" id="estrelas" class="form-select form-select-sm d-inline-block"
                        style="width: auto;" {% if not necessidade.status == "finalizado" %} disabled {% endif %}>
                        <option value="5" {% if not necessidade.status == "finalizado" %} selected {% endif %}>★★★★★</option>
                        <option value="4">★★★★</option>
                        <option value="3">★★★</option>
                        <option value="2">★★</option>
                        <option value="1">★</option>
                    </select>
                    <button type="submit" class="btn btn-success btn-sm ms-2" {% if not necessidade.status == "finalizado" %}
                        disabled {% endif %}>
                        Enviar
                    </button>
                </form>
                {% endif %} -->
            </div>

            {% if user == necessidade.cliente and necessidade.status == 'em_atendimento' %}
            {% for orcamento in necessidade.orcamentos.all %}
            {% if orcamento.status == 'aceito' %}
            <button class="btn btn-primary btn-finalizar" data-url="{% url 'finalizar_anuncio' necessidade.pk %}"
                data-bs-toggle="modal" data-bs-target="#confirmarFinalizacaoModal" data-bs-toggle="tooltip"
                data-bs-placement="top" title="Finalizar Anúncio">
                <i class="fas fa-check-circle"></i> Finalizar Anúncio
            </button>
            {% endif %}
            {% endfor %}
            {% endif %}

            <hr>
            <h3 class="mb-4">Localização</h3>
            <div class="d-flex justify-content-around">
                <p><strong>CEP:</strong> {{ necessidade.cliente.cep }}</p>
                <p><strong>Cidade:</strong> {{ necessidade.cliente.cidade }}</p>
                <p><strong>Bairro:</strong> {{ necessidade.cliente.bairro }}</p>
            </div>
            <hr>
            <h3>Orçamentos Recebidos</h3>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                    <thead>
                        <tr>
                            <th>Fornecedor</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for orcamento in necessidade.orcamentos.all %}
                        <tr>
                            <td>{{ orcamento.fornecedor.get_full_name }}</td>
                            <td>{{ orcamento.valor|moeda_brasileira }}</td>
                            <td>
                                <span class="badge 
                                {% if orcamento.status == 'pendente' %} text-bg-secondary
                                {% elif orcamento.status == 'aguardando_aceite_fornecedor' %} text-bg-warning
                                {% elif orcamento.status == 'aceito' %} text-bg-success
                                {% elif orcamento.status == 'rejeitado' %} text-bg-danger
                                {% endif %}">
                                Status: {{ orcamento.get_status_display }}
                            </td>
                            
                            <td>{{ orcamento.data_criacao|date:"d/m/Y" }}</td>
                            <td>
                                <div class="d-flex flex-wrap gap-2">
                                    {% if orcamento.arquivo_anexo %}
                                    {% if user == necessidade.cliente or user == orcamento.fornecedor %}
                                    <a href="{{ orcamento.arquivo_anexo.url }}" target="_blank" class="btn btn-primary"
                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Baixar Anexo">
                                        <i class="fas fa-file-download"></i>
                                    </a>
                                    {% else %}
                                    <span class="badge bg-secondary" data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Você não tem permissão para baixar este anexo">
                                        <i class="fas fa-lock"></i> Restrito
                                    </span>
                                    {% endif %}
                                    {% else %}
                                    <span class="badge bg-danger">Sem anexo</span>
                                    {% endif %}

                                    {% if user == necessidade.cliente %}
                                    {% if orcamento.status == "pendente" %}
                                    <button class="btn btn-success btn-aceitar"
                                        data-url="{% url 'aceitar_orcamento' orcamento.id %}" data-bs-toggle="modal"
                                        data-bs-target="#confirmarAceiteModal" title="Aceitar Orçamento">
                                        <i class="fas fa-thumbs-up"></i>
                                    </button>
                                    {% else %}
                                    <span data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Orçamento já processado. Não pode ser aceito.">
                                        <button class="btn btn-success" disabled>
                                            <i class="fas fa-thumbs-up"></i>
                                        </button>
                                    </span>
                                    {% endif %}
                                    {% endif %}

                                    {% if user == necessidade.cliente and necessidade.status == "em_andamento" %}
                                    {% if orcamento.status == "pendente" %}
                                    <button class="btn btn-danger btn-rejeitar"
                                        data-url="{% url 'rejeitar_orcamento' orcamento.id %}" data-bs-toggle="modal"
                                        data-bs-target="#confirmarRejeicaoModal" title="Rejeitar Orçamento">
                                        <i class="fas fa-thumbs-down"></i>
                                    </button>
                                    {% else %}
                                    <span data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Este orçamento já foi processado e não pode ser rejeitado.">
                                        <button class="btn btn-danger" disabled>
                                            <i class="fas fa-thumbs-down"></i>
                                        </button>
                                    </span>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">Nenhum orçamento recebido ainda.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Coluna Direita: Cards -->
        <div class="col-md-4">
            <!-- Primeiro Card: Categoria e Contato -->
            <div class="card mb-4 shadow">
                <div class="card-body">
                    <h5 class="card-title">Categoria</h5>
                    <p class="card-text">{{ necessidade.categoria.nome }}</p>
                    <span class="badge text-bg-success">Status: {{ necessidade.get_status_display|capfirst}}</span>
                    <hr>
                    <h5 class="card-title"><i class="fas fa-phone-alt me-2"></i>{{ necessidade.cliente.telefone }}</h5>

                    <div class="d-flex justify-content-around mt-3">
                        <a href="#" class="btn btn-primary" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Iniciar Chat com o Anunciante">
                            <i class="fas fa-comments"></i>
                        </a>
                        <span data-bs-toggle="tooltip" data-bs-placement="top" title="{% if user == necessidade.cliente or necessidade.status not in 'ativo em_andamento' %}
                                     Você não pode submeter orçamento neste anúncio.
                                     {% else %}
                                     Enviar orçamento para este anúncio
                                     {% endif %}">
                            <a href="{% if user != necessidade.cliente and necessidade.status in 'ativo em_andamento' %}
                                     {% url 'submeter_orcamento' necessidade.pk %}
                                     {% else %}#{% endif %}"
                                class="btn btn-warning 
                                      {% if user == necessidade.cliente or necessidade.status not in 'ativo em_andamento' %}disabled{% endif %}">
                                <i class="fas fa-folder-plus"></i>
                            </a>
                        </span>

                    </div>
                </div>
            </div>

            <!-- Segundo Card: Informações do Anunciante -->
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title"> <i class="fas fa-bullhorn text-primary"></i> Anunciante</h5>
                    <p><strong>Nome:</strong> {{ necessidade.cliente.get_full_name|capfirst }}</p>
                    <p><strong>Último Acesso:</strong> {{ necessidade.cliente.last_login|date:"d/m/Y H:i" }}</p>
                    <p><strong>Data de Cadastro:</strong> {{ necessidade.cliente.date_joined|date:"d/m/Y" }}</p>
                    <p><strong>Endereço:</strong> {{ necessidade.cliente.endereco }}</p>
                    <a href="{% url 'user_profile' necessidade.cliente.pk %}" class="btn btn-secondary w-100">
                        <i class="fas fa-user me-2"></i> Ver Perfil
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmarAceiteModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Confirmar Aceite do Orçamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja aceitar este orçamento?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="confirmarAceiteBtn">Aceitar</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal de Confirmação de Rejeição -->
<div class="modal fade" id="confirmarRejeicaoModal" tabindex="-1" aria-labelledby="modalRejeicaoLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalRejeicaoLabel">Confirmar Rejeição do Orçamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja rejeitar este orçamento?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmarRejeicaoBtn">Rejeitar</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal de Confirmação de Finalização do Anuncio -->
<div class="modal fade" id="confirmarFinalizacaoModal" tabindex="-1" aria-labelledby="modalFinalizacaoLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalFinalizacaoLabel">Confirmar Finalização</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja finalizar este anúncio? Essa ação não poderá ser desfeita.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmarFinalizacaoBtn">Finalizar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let aceitarUrl = null;

        // Captura a URL ao abrir o modal
        document.querySelectorAll('.btn-aceitar').forEach(btn => {
            btn.addEventListener('click', function () {
                aceitarUrl = this.getAttribute('data-url');
            });
        });

        // Envia requisição AJAX ao clicar no botão de confirmação
        document.getElementById('confirmarAceiteBtn').addEventListener('click', function () {
            if (aceitarUrl) {
                fetch(aceitarUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erro ao aceitar orçamento: ' + (data.error || 'Tente novamente.'));
                        }
                    });
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let rejeitarUrl = null;

        // Captura a URL ao abrir o modal de rejeição
        document.querySelectorAll('.btn-rejeitar').forEach(btn => {
            btn.addEventListener('click', function () {
                rejeitarUrl = this.getAttribute('data-url');
            });
        });

        // Envia requisição AJAX ao clicar no botão de confirmação
        document.getElementById('confirmarRejeicaoBtn').addEventListener('click', function () {
            if (rejeitarUrl) {
                fetch(rejeitarUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erro ao rejeitar orçamento: ' + (data.error || 'Tente novamente.'));
                        }
                    });
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let finalizarUrl = null;

        // Captura a URL ao abrir o modal
        document.querySelector('.btn-finalizar').addEventListener('click', function () {
            finalizarUrl = this.getAttribute('data-url');
        });

        // Envia requisição AJAX ao clicar no botão de confirmação
        document.getElementById('confirmarFinalizacaoBtn').addEventListener('click', function () {
            if (finalizarUrl) {
                fetch(finalizarUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Fecha o modal
                            const modal = document.getElementById('confirmarFinalizacaoModal');
                            const bootstrapModal = bootstrap.Modal.getInstance(modal);
                            bootstrapModal.hide();

                            // Exibe mensagem de sucesso
                            alert(data.message);

                            // Atualiza a página para refletir o novo status
                            location.reload();
                        } else {
                            // Exibe o erro retornado
                            alert('Erro ao finalizar anúncio: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Erro na requisição:', error);
                        alert('Erro inesperado. Tente novamente.');
                    });
            }
        });
    });

</script>

{% endblock %}