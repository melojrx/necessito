<!-- Modal: Avalia√ß√£o DEFINITIVO -->
<div class="modal fade" id="avaliacaoModal" tabindex="-1" aria-labelledby="avaliacaoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="avaliacaoModalLabel">
                    <i class="fas fa-star-half-alt me-2"></i>Avaliar Negocia√ß√£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="avaliacao-form-container" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Carregando formul√°rio de avalia√ß√£o...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// SISTEMA DE CARREGAMENTO DEFINITIVO DO MODAL
console.log('üîß Configurando modal de avalia√ß√£o definitivo...');

document.addEventListener('DOMContentLoaded', function() {
    const avaliacaoModal = document.getElementById('avaliacaoModal');
    const formContainer = document.getElementById('avaliacao-form-container');

    if (!avaliacaoModal || !formContainer) {
        console.error('‚ùå Elementos do modal n√£o encontrados!');
        return;
    }

    avaliacaoModal.addEventListener('show.bs.modal', function () {
        console.log('üîÑ Abrindo modal de avalia√ß√£o...');
        
        // Reset do container com loading
        formContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 text-muted">Carregando formul√°rio de avalia√ß√£o...</p>
            </div>`;

        // Carregar formul√°rio via AJAX
        fetch("{% url 'rankings:avaliar_negociacao' necessidade.pk %}", {
            headers: { 
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'text/html'
            }
        })
        .then(response => {
            console.log(`üì° Resposta recebida: ${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.text();
        })
        .then(html => {
            console.log('‚úÖ HTML do formul√°rio carregado');
            
            // Inserir HTML no container
            formContainer.innerHTML = html;
            
            // Aguarda DOM ser atualizado e executa inicializa√ß√£o
            setTimeout(() => {
                console.log('üéØ Inicializando sistema definitivo...');
                
                // Tenta inicializar com a fun√ß√£o definitiva
                if (typeof window.initAvaliacaoFinal === 'function') {
                    window.initAvaliacaoFinal();
                    console.log('‚úÖ Sistema definitivo inicializado!');
                } else {
                    console.warn('‚ö†Ô∏è Fun√ß√£o initAvaliacaoFinal n√£o encontrada, aguardando...');
                    
                    // Fallback com m√∫ltiplas tentativas
                    let attempts = 0;
                    const maxAttempts = 20;
                    
                    const tryInit = () => {
                        attempts++;
                        
                        if (typeof window.initAvaliacaoFinal === 'function') {
                            window.initAvaliacaoFinal();
                            console.log('‚úÖ Sistema definitivo inicializado ap√≥s tentativas!');
                            return;
                        }
                        
                        if (attempts < maxAttempts) {
                            setTimeout(tryInit, 100);
                        } else {
                            console.error('‚ùå Falha ao inicializar ap√≥s m√∫ltiplas tentativas');
                        }
                    };
                    
                    tryInit();
                }
                
                // Notificar conclus√£o
                document.dispatchEvent(new CustomEvent('avaliacaoModalLoaded', {
                    detail: { 
                        success: true, 
                        container: formContainer,
                        timestamp: Date.now()
                    }
                }));
                
            }, 100);
        })
        .catch(error => {
            console.error('üí• Erro ao carregar formul√°rio:', error);
            
            formContainer.innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Erro ao carregar formul√°rio</strong><br>
                    <small class="text-muted">${error.message}</small><br>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="location.reload()">
                        Recarregar P√°gina
                    </button>
                </div>`;
        });
    });
    
    console.log('‚úÖ Modal de avalia√ß√£o configurado com sucesso!');
});
</script>
