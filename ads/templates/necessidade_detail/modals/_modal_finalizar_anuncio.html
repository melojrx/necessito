<!-- Modal: Finalizar Anúncio -->
<div class="modal fade" id="finalizarAnuncioModal" tabindex="-1" aria-labelledby="finalizarAnuncioLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finalizarAnuncioLabel"><i class="fas fa-flag-checkered me-2 text-primary"></i>Confirmar Finalização do Anúncio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Ao finalizar, você confirma que o serviço/produto foi entregue conforme o combinado.</p>
                <p>Esta ação é irreversível e liberará a opção de avaliação mútua entre você e o fornecedor.</p>
                <strong>Deseja realmente finalizar este anúncio?</strong>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmarFinalizacaoBtn">Sim, Finalizar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const finalizarAnuncioModal = document.getElementById('finalizarAnuncioModal');
    if (finalizarAnuncioModal) {
        const confirmarFinalizacaoBtn = document.getElementById('confirmarFinalizacaoBtn');
        
        confirmarFinalizacaoBtn.addEventListener('click', () => {
            const finalizarUrl = "{% url 'ads:finalizar_anuncio' necessidade.pk %}";

            fetch(finalizarUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Ocorreu um erro ao tentar finalizar o anúncio.');
                }
            })
            .catch(err => alert('Erro de comunicação com o servidor. Tente novamente.'));
        });
    }
});
</script>
