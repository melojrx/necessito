{% extends 'base.html' %}

{% block title %}Meus Anúncios{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Meus Anúncios</h1>
    <div class="row align-items-center mb-4">
      <!-- Formulário de busca -->
      <div class="col-lg-8 col-md-8 col-sm-12">
          <form method="get" action="{% url 'ads:necessidade_list' %}">
              <div class="row g-2">
                  <!-- Campo de busca -->
                  <div class="col-lg-5 col-md-6 col-sm-12">
                      <div class="input-group">
                          <input type="text" class="form-control" name="search" placeholder="Buscar por descrição" value="{{ request.GET.search }}">
                      </div>
                  </div>
                  <!-- Campo de seleção de status -->
                  <div class="col-lg-4 col-md-6 col-sm-12">
                      <select class="form-select" name="status">
                          <option value="" {% if not request.GET.status %}selected{% endif %}>Todos os Status</option>
                          <option value="ativo" {% if request.GET.status == 'ativo' %}selected{% endif %}>Ativo</option>
                          <option value="analisando_orcamentos" {% if request.GET.status == 'analisando_orcamentos' %}selected{% endif %}>Analisando orçamentos</option>
                          <option value="aguardando_confirmacao" {% if request.GET.status == 'aguardando_confirmacao' %}selected{% endif %}>Aguardando confirmação</option>
                          <option value="em_atendimento" {% if request.GET.status == 'em_atendimento' %}selected{% endif %}>Em atendimento</option>
                          <option value="finalizado" {% if request.GET.status == 'finalizado' %}selected{% endif %}>Finalizado</option>
                          <option value="cancelado" {% if request.GET.status == 'cancelado' %}selected{% endif %}>Cancelado</option>
                          <option value="expirado" {% if request.GET.status == 'expirado' %}selected{% endif %}>Expirado</option>
                          <option value="em_disputa" {% if request.GET.status == 'em_disputa' %}selected{% endif %}>Em disputa</option>
                      </select>
                  </div>
                  <!-- Botão de buscar -->
                  <div class="col-lg-3 col-md-12 col-sm-12">
                      <button type="submit" class="btn btn-primary">
                          <i class="fas fa-search"></i> Buscar
                      </button>
                  </div>
              </div>
          </form>
      </div>
      <!-- Botão "Novo Anúncio" -->
      <div class="col-lg-4 col-md-4 col-sm-12 text-end">
          <a href="{% url 'ads:necessidade_create' %}" class="btn btn-success">
              <i class="bi bi-plus"></i> Novo Anúncio
          </a>
      </div>
  </div>
  
    <div class="row">
        {% for necessidade in necessidades %}
        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
            <div class="necessity-card card h-100 shadow-sm border-0" 
                 data-status="{{ necessidade.status }}"
                 data-necessidade-id="{{ necessidade.id }}"
                 x-data="necessidadeCard({{ necessidade|default:'{}' }})"
                 :class="getStatusClass()">
                <!-- Card Header with Badges -->
                <div class="card-badge-container position-relative">
                    {% comment "Urgent badge - can be added later based on business rules" %}
                    {% if necessidade.is_urgent %}
                        <span class="badge badge-urgent position-absolute top-0 start-0 m-2">
                            <i class="fas fa-fire"></i> Urgente
                        </span>
                    {% endif %}
                    {% endcomment %}
                    
                    <span class="badge badge-category position-absolute top-0 end-0 m-2 bg-light text-dark">
                        {{ necessidade.categoria.nome }}
                    </span>
                </div>
                
                <div class="card-body p-4">
                    <!-- Title -->
                    <h5 class="card-title mb-3 fw-bold text-dark">{{ necessidade.titulo }}</h5>
                    
                    <!-- Description -->
                    <p class="card-text text-muted mb-3">{{ necessidade.descricao|truncatechars:120 }}</p>
                    
                    <!-- Meta Information -->
                    <div class="card-meta d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center text-muted small">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            <span>{{ necessidade.cliente.cidade|default:"Não informado" }}, {{ necessidade.cliente.estado|default:"" }}</span>
                        </div>
                        <div class="d-flex align-items-center text-muted small">
                            <i class="fas fa-comment-dots me-1"></i>
                            <span>{{ necessidade.orcamentos.count }} proposta{{ necessidade.orcamentos.count|pluralize:",s" }}</span>
                        </div>
                    </div>
                    
                    <!-- Client Trust Badges -->
                    <div class="client-badges mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <span class="small text-muted">Cliente:</span>
                            <strong class="small">{{ necessidade.cliente.get_full_name }}</strong>
                        </div>
                        {% include 'components/user_badges.html' with user=necessidade.cliente show_score=False %}
                    </div>
                    
                    <!-- Status Progress Bar -->
                    <div class="status-timeline mb-3">
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar" 
                                 style="width: {% if necessidade.status == 'ativo' %}20%{% elif necessidade.status == 'analisando_orcamentos' %}40%{% elif necessidade.status == 'aguardando_confirmacao' %}60%{% elif necessidade.status == 'em_atendimento' %}80%{% elif necessidade.status == 'finalizado' %}100%{% elif necessidade.status == 'cancelado' %}100%{% elif necessidade.status == 'expirado' %}100%{% elif necessidade.status == 'em_disputa' %}70%{% else %}0%{% endif %}; 
                                        background-color: {% if necessidade.status == 'ativo' %}var(--bs-primary){% elif necessidade.status == 'analisando_orcamentos' %}var(--bs-info){% elif necessidade.status == 'aguardando_confirmacao' %}var(--bs-warning){% elif necessidade.status == 'em_atendimento' %}var(--bs-info){% elif necessidade.status == 'finalizado' %}var(--bs-success){% elif necessidade.status == 'cancelado' %}var(--bs-danger){% elif necessidade.status == 'expirado' %}var(--bs-secondary){% elif necessidade.status == 'em_disputa' %}var(--bs-danger){% else %}var(--bs-secondary){% endif %};">
                            </div>
                        </div>
                        <small class="text-muted mt-1 d-block">{{ necessidade.get_status_display }}</small>
                    </div>
                    
                    <!-- Status Badge -->
                    <div class="mb-3">
                        <span class="badge rounded-pill 
                            {% if necessidade.status == 'ativo' %}bg-primary{% elif necessidade.status == 'analisando_orcamentos' %}bg-info{% elif necessidade.status == 'aguardando_confirmacao' %}bg-warning text-dark{% elif necessidade.status == 'em_atendimento' %}bg-info text-white{% elif necessidade.status == 'finalizado' %}bg-success{% elif necessidade.status == 'cancelado' %}bg-danger{% elif necessidade.status == 'expirado' %}bg-secondary{% elif necessidade.status == 'em_disputa' %}bg-danger{% else %}bg-secondary{% endif %}">
                            <i class="fas 
                                {% if necessidade.status == 'ativo' %}fa-play{% elif necessidade.status == 'analisando_orcamentos' %}fa-search{% elif necessidade.status == 'aguardando_confirmacao' %}fa-clock{% elif necessidade.status == 'em_atendimento' %}fa-tools{% elif necessidade.status == 'finalizado' %}fa-check{% elif necessidade.status == 'cancelado' %}fa-times-circle{% elif necessidade.status == 'expirado' %}fa-calendar-times{% elif necessidade.status == 'em_disputa' %}fa-exclamation-triangle{% else %}fa-question{% endif %} me-1">
                            </i>
                            {{ necessidade.get_status_display }}
                        </span>
                    </div>
                    
                    <!-- Timestamps -->
                    <div class="text-muted small mb-3">
                        <i class="fas fa-calendar-alt me-1"></i>
                        Criado em {{ necessidade.data_criacao|date:"d/m/Y H:i" }}
                        {% if necessidade.modificado_em and necessidade.modificado_em != necessidade.data_criacao %}
                            <br><i class="fas fa-edit me-1"></i>
                            Atualizado {{ necessidade.modificado_em|timesince }} atrás
                        {% endif %}
                    </div>
                </div>
                
                <!-- Card Actions -->
                <div class="card-footer bg-transparent border-0 p-4 pt-0">
                    <div class="d-flex flex-column gap-2">
                        <!-- Primary Action -->
                        <a href="{% url 'ads:necessidade_detail' necessidade.pk %}" 
                           class="btn btn-primary btn-sm d-flex align-items-center justify-content-center">
                            <i class="fas fa-eye me-2"></i>
                            Ver Detalhes
                        </a>
                        
                        <!-- Secondary Actions -->
                        <div class="d-flex gap-2">
                            <a href="{% url 'ads:necessidade_update' necessidade.pk %}" 
                               class="btn btn-outline-warning btn-sm flex-fill">
                                <i class="fas fa-edit me-1"></i>
                                Editar
                            </a>
                            <a href="{% url 'ads:necessidade_delete' necessidade.pk %}" 
                               class="btn btn-outline-danger btn-sm flex-fill"
                               onclick="return confirm('Tem certeza que deseja excluir este anúncio?')">
                                <i class="fas fa-trash me-1"></i>
                                Excluir
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
