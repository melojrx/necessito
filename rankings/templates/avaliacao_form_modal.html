{% load static %}

<style>
.rating-criteria {
    margin-bottom: 2rem;
}

.rating-criteria .mb-3 {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.rating-criteria .form-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.rating-labels {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #6c757d;
}

/* ESTILOS ROBUSTOS PARA ESTRELAS */
.star-rating {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin: 15px 0;
    user-select: none;
    position: relative;
}

.star-rating .star-label {
    width: 40px;
    height: 40px;
    background: url('/static/img/star-empty.svg') no-repeat center center;
    background-size: contain;
    cursor: pointer;
    transition: all 0.2s ease;
    filter: grayscale(0.3);
    display: inline-block;
    border: none;
    outline: none;
    position: relative;
    z-index: 1;
}

.star-rating .star-label:hover {
    transform: scale(1.1);
    filter: grayscale(0);
}

.star-rating .star-label:active {
    transform: scale(0.95);
}

.star-rating .star-label.filled {
    background-image: url('/static/img/star-filled.svg');
    filter: grayscale(0);
}

.star-rating input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 1px;
    height: 1px;
    pointer-events: none;
}
</style>
  
<form method="post" action="{% url 'rankings:avaliar_negociacao' necessidade.pk %}" id="form-avaliacao">
  {% csrf_token %}

  <p class="mb-3">
    {% if tipo_avaliacao == 'fornecedor' %}
      Avalie o <strong>fornecedor</strong> com base nos seguintes crit√©rios:
    {% else %}
      Avalie o <strong>cliente</strong> com base nos seguintes crit√©rios:
    {% endif %}
  </p>

  <div class="rating-criteria">
    {% for field in form %}
      {% if field.name|slice:":9" == "criterio_" %}
        <div class="mb-3">
          <label class="form-label">{{ field.label }}</label>
          <div class="star-rating-container">
            {{ field }}
            <div class="rating-labels d-flex justify-content-between">
              <small>Nada satisfeito</small>
              <small>Muito satisfeito</small>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
    <button type="submit" class="btn btn-primary" id="submit-avaliacao">
      <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
      Enviar Avalia√ß√£o
    </button>
  </div>
</form>

<script>
// SISTEMA DE ESTRELAS ROBUSTO COM EVENT DELEGATION
console.log('=== SISTEMA DE ESTRELAS DEFINITIVO CARREGANDO ===');

(function() {
    'use strict';
    
    // Estado global para evitar m√∫ltiplas inicializa√ß√µes
    let initialized = false;
    
    // Fun√ß√£o principal de inicializa√ß√£o
    function initRobustStarSystem() {
        if (initialized) {
            console.log('‚ö†Ô∏è Sistema j√° inicializado, pulando...');
            return;
        }
        
        console.log('üöÄ Inicializando sistema robusto de estrelas...');
        
        // Remove listeners antigos se existirem
        document.removeEventListener('click', handleStarClick);
        document.removeEventListener('mouseenter', handleStarHover, true);
        document.removeEventListener('mouseleave', handleContainerLeave, true);
        
        // Adiciona event delegation no documento
        document.addEventListener('click', handleStarClick);
        document.addEventListener('mouseenter', handleStarHover, true);
        document.addEventListener('mouseleave', handleContainerLeave, true);
        
        // Inicializa estrelas existentes
        initializeExistingStars();
        
        initialized = true;
        console.log('‚úÖ Sistema de estrelas inicializado com EVENT DELEGATION');
    }
    
    // Handler para cliques nas estrelas
    function handleStarClick(event) {
        const target = event.target;
        
        // Verifica se o clique foi em uma label de estrela
        if (!target.classList.contains('star-label') || !target.closest('.star-rating')) {
            return;
        }
        
        event.preventDefault();
        event.stopPropagation();
        
        const container = target.closest('.star-rating');
        const rating = parseInt(target.getAttribute('data-rating'));
        
        console.log(`üñ±Ô∏è CLICK detectado na estrela ${rating}`);
        
        if (!rating || rating < 1 || rating > 5) {
            console.error('‚ùå Rating inv√°lido:', rating);
            return;
        }
        
        // Encontra e marca o input correspondente
        const input = container.querySelector(`input[value="${rating}"]`);
        if (!input) {
            console.error(`‚ùå Input n√£o encontrado para rating ${rating}`);
            return;
        }
        
        // Desmarca todos os inputs do container
        const allInputs = container.querySelectorAll('input[type="radio"]');
        allInputs.forEach(inp => inp.checked = false);
        
        // Marca o input selecionado
        input.checked = true;
        
        // Atualiza visual
        updateStarVisual(container, rating);
        
        // Dispara evento de mudan√ßa
        input.dispatchEvent(new Event('change', { bubbles: true }));
        
        console.log(`‚úÖ Estrela ${rating} selecionada com sucesso`);
    }
    
    // Handler para hover nas estrelas
    function handleStarHover(event) {
        const target = event.target;
        
        if (!target.classList.contains('star-label') || !target.closest('.star-rating')) {
            return;
        }
        
        const container = target.closest('.star-rating');
        const rating = parseInt(target.getAttribute('data-rating'));
        
        if (rating >= 1 && rating <= 5) {
            updateStarVisual(container, rating, true);
        }
    }
    
    // Handler para quando o mouse sai do container
    function handleContainerLeave(event) {
        const target = event.target;
        
        if (!target.classList.contains('star-rating')) {
            return;
        }
        
        const checkedInput = target.querySelector('input:checked');
        const currentRating = checkedInput ? parseInt(checkedInput.value) : 0;
        updateStarVisual(target, currentRating);
    }
    
    // Atualiza o visual das estrelas
    function updateStarVisual(container, rating, isHover = false) {
        const labels = container.querySelectorAll('.star-label');
        
        labels.forEach((label, index) => {
            const starNumber = index + 1;
            const shouldFill = starNumber <= rating;
            
            // Remove classes antigas
            label.classList.remove('filled');
            
            // Aplica novo estado
            if (shouldFill) {
                label.classList.add('filled');
                label.style.transform = isHover ? 'scale(1.1)' : 'scale(1)';
            } else {
                label.style.transform = 'scale(1)';
            }
        });
        
        console.log(`üé® Visual atualizado: ${rating} estrelas ${isHover ? '(hover)' : ''}`);
    }
    
    // Inicializa estrelas j√° presentes no DOM
    function initializeExistingStars() {
        const containers = document.querySelectorAll('.star-rating');
        console.log(`üìã Inicializando ${containers.length} containers existentes`);
        
        containers.forEach((container, index) => {
            console.log(`üîß Configurando container ${index + 1}`);
            
            // Garante que as labels t√™m data-rating corretos
            const labels = container.querySelectorAll('.star-label');
            labels.forEach((label, labelIndex) => {
                if (!label.getAttribute('data-rating')) {
                    label.setAttribute('data-rating', labelIndex + 1);
                }
            });
            
            // Aplica estado visual inicial
            const checkedInput = container.querySelector('input:checked');
            const initialRating = checkedInput ? parseInt(checkedInput.value) : 0;
            updateStarVisual(container, initialRating);
            
            console.log(`‚úÖ Container ${index + 1} configurado`);
        });
    }
    
    // Valida√ß√£o de formul√°rio e envio AJAX
    function setupFormValidation() {
        const form = document.querySelector('form[method="post"]');
        if (!form) return;
        
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Sempre prevenir envio padr√£o
            
            const containers = form.querySelectorAll('.star-rating');
            let missing = [];
            
            containers.forEach(container => {
                const checked = container.querySelector('input:checked');
                if (!checked) {
                    const fieldName = container.getAttribute('data-field') || 'crit√©rio';
                    missing.push(fieldName);
                }
            });
            
            if (missing.length > 0) {
                alert(`Por favor, avalie todos os crit√©rios: ${missing.join(', ')}`);
                return false;
            }
            
            // Envio via AJAX
            submitAvaliacaoForm(form);
        });
    }
    
    // Fun√ß√£o para envio AJAX da avalia√ß√£o
    function submitAvaliacaoForm(form) {
        const submitBtn = form.querySelector('#submit-avaliacao');
        const spinner = submitBtn.querySelector('.spinner-border');
        
        console.log('üì§ Enviando avalia√ß√£o via AJAX...');
        
        // UI de loading
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
        
        // Preparar dados do formul√°rio
        const formData = new FormData(form);
        
        // Log dos dados para debug
        console.log('üìã Dados do formul√°rio:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            console.log(`üì® Resposta recebida: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('üì¶ Dados da resposta:', data);
            
            if (data.success) {
                console.log('‚úÖ Avalia√ß√£o enviada com sucesso!');
                
                // Fechar modal
                const modal = document.getElementById('avaliacaoModal');
                if (modal) {
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
                
                // Mostrar mensagem de sucesso
                alert('Avalia√ß√£o registrada com sucesso!');
                
                // Recarregar p√°gina ap√≥s um breve delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } else {
                console.error('‚ùå Erro na avalia√ß√£o:', data.message);
                alert(`Erro: ${data.message}`);
                
                if (data.errors) {
                    console.error('Erros espec√≠ficos:', data.errors);
                }
            }
        })
        .catch(error => {
            console.error('üí• Erro na requisi√ß√£o:', error);
            alert('Erro de conex√£o. Tente novamente.');
        })
        .finally(() => {
            // Restaurar UI
            submitBtn.disabled = false;
            spinner.classList.add('d-none');
            console.log('üîÑ UI restaurada');
        });
    }
    
    // Fun√ß√£o global para inicializa√ß√£o externa
    window.initializeStarRating = function() {
        console.log('üîÑ Reinicializando sistema de estrelas...');
        initialized = false;
        initRobustStarSystem();
    };
    
    // Fun√ß√£o de debug
    window.debugStarsRobust = function() {
        console.log('üîç DEBUG SISTEMA ROBUSTO:');
        console.log('Initialized:', initialized);
        
        const containers = document.querySelectorAll('.star-rating');
        console.log(`Containers encontrados: ${containers.length}`);
        
        containers.forEach((container, index) => {
            const labels = container.querySelectorAll('.star-label');
            const inputs = container.querySelectorAll('input[type="radio"]');
            const checked = container.querySelector('input:checked');
            
            console.log(`Container ${index + 1}:`);
            console.log('  Labels:', labels.length);
            console.log('  Inputs:', inputs.length);
            console.log('  Checked:', checked ? checked.value : 'nenhum');
        });
    };
    
    // Inicializa√ß√£o
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initRobustStarSystem();
            setupFormValidation();
        });
    } else {
        initRobustStarSystem();
        setupFormValidation();
    }
    
    console.log('üìù Sistema robusto carregado! Use window.debugStarsRobust() para debug.');
})();
</script>
