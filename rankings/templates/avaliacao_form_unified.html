{% load static %}

<!-- SISTEMA DE AVALIA√á√ÉO UNIFICADO E FUNCIONAL -->
<style>
.rating-section {
    background: #f8f9fa;
    padding: 1.5rem;
    margin: 1rem 0;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.rating-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 1rem;
}

.stars-container {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 1rem 0;
}

.star {
    font-size: 35px;
    color: #ddd;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
}

.star:hover {
    color: #ffc107;
    transform: scale(1.2);
}

.star.filled {
    color: #ffc107;
}

.rating-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.5rem;
}

.validation-error {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    display: none;
}

.current-rating {
    text-align: center;
    margin-top: 0.5rem;
    font-weight: 500;
    color: #0d6efd;
}
</style>

<form method="post" action="{% url 'rankings:avaliar_negociacao' necessidade.pk %}" id="avaliacaoFormUnified">
    {% csrf_token %}
    
    <div class="mb-3">
        <p class="text-center">
            {% if tipo_avaliacao == 'fornecedor' %}
                Avalie o <strong>fornecedor</strong> com base nos seguintes crit√©rios:
            {% else %}
                Avalie o <strong>cliente</strong> com base nos seguintes crit√©rios:
            {% endif %}
        </p>
    </div>

    {% for field in form %}
        {% if field.name|slice:":9" == "criterio_" %}
            <div class="rating-section">
                <div class="rating-title">{{ field.label }}</div>
                
                <!-- Container das estrelas com identificadores √∫nicos -->
                <div class="stars-container" data-field="{{ field.name }}" data-required="true">
                    <span class="star" data-value="1" title="1 estrela">‚òÖ</span>
                    <span class="star" data-value="2" title="2 estrelas">‚òÖ</span>
                    <span class="star" data-value="3" title="3 estrelas">‚òÖ</span>
                    <span class="star" data-value="4" title="4 estrelas">‚òÖ</span>
                    <span class="star" data-value="5" title="5 estrelas">‚òÖ</span>
                </div>
                
                <!-- Input oculto para enviar o valor -->
                <input type="hidden" name="{{ field.name }}" value="" id="input-{{ field.name }}" required>
                
                <div class="rating-labels">
                    <small>Nada satisfeito</small>
                    <small>Muito satisfeito</small>
                </div>
                
                <div class="current-rating" id="rating-display-{{ field.name }}">
                    Clique nas estrelas para avaliar
                </div>
                
                <div class="validation-error" id="error-{{ field.name }}">
                    Por favor, avalie este crit√©rio.
                </div>
            </div>
        {% endif %}
    {% endfor %}

    <div class="modal-footer mt-4">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="submitBtnUnified">
            <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
            Enviar Avalia√ß√£o
        </button>
    </div>
</form>

<script>
// SISTEMA DE ESTRELAS UNIFICADO - GARANTIDO PARA FUNCIONAR
console.log('üåü SISTEMA UNIFICADO DE AVALIA√á√ïES CARREGANDO...');

// Namespace para evitar conflitos
window.AvaliacaoUnificada = window.AvaliacaoUnificada || {};

window.AvaliacaoUnificada.init = function() {
    console.log('üöÄ Inicializando sistema unificado de avalia√ß√£o...');
    
    const form = document.getElementById('avaliacaoFormUnified');
    if (!form) {
        console.error('‚ùå Formul√°rio n√£o encontrado!');
        return;
    }
    
    // Configurar containers de estrelas
    const containers = form.querySelectorAll('.stars-container');
    console.log(`üìä Encontrados ${containers.length} containers de estrelas`);
    
    if (containers.length === 0) {
        console.error('‚ùå Nenhum container de estrelas encontrado!');
        return;
    }
    
    // Configurar cada container
    containers.forEach(setupStarContainer);
    
    // Configurar envio do formul√°rio
    setupFormSubmission(form);
    
    // NOVA FUNCIONALIDADE: Verifica√ß√£o peri√≥dica do estado visual
    startVisualStateMonitor(form);
    
    console.log('‚úÖ Sistema unificado inicializado com SUCESSO!');
};

function setupStarContainer(container) {
    const fieldName = container.getAttribute('data-field');
    const stars = container.querySelectorAll('.star');
    const hiddenInput = document.getElementById(`input-${fieldName}`);
    const ratingDisplay = document.getElementById(`rating-display-${fieldName}`);
    const errorDiv = document.getElementById(`error-${fieldName}`);
    
    console.log(`üîß Configurando ${stars.length} estrelas para ${fieldName}`);
    
    if (!hiddenInput) {
        console.error(`‚ùå Input oculto n√£o encontrado para ${fieldName}`);
        return;
    }
    
    // Configurar cada estrela
    stars.forEach((star, index) => {
        const value = parseInt(star.getAttribute('data-value'));
        
        // Remove listeners antigos para evitar duplica√ß√£o
        star.removeEventListener('click', star._clickHandler);
        star.removeEventListener('mouseenter', star._hoverHandler);
        
        // CLICK handler
        star._clickHandler = function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log(`üñ±Ô∏è CLICK detectado na estrela ${value}`);
            console.log(`üìù Atualizando input: ${fieldName}`);
            
            // Atualizar valor do input
            hiddenInput.value = value;
            
            // Atualizar visual das estrelas IMEDIATAMENTE
            updateStarsVisual(container, value);
            
            // GARANTIA EXTRA: Re-aplicar estado visual ap√≥s pequeno delay
            setTimeout(() => {
                updateStarsVisual(container, value);
                console.log(`‚úÖ Estrela ${value} selecionada com sucesso!`);
            }, 50);
            
            // Atualizar display de rating
            if (ratingDisplay) {
                const ratingText = [
                    '', 'Muito Insatisfeito', 'Insatisfeito', 'Neutro', 'Satisfeito', 'Muito Satisfeito'
                ];
                ratingDisplay.textContent = `${value} estrela${value > 1 ? 's' : ''} - ${ratingText[value] || ''}`;
                ratingDisplay.style.color = value >= 4 ? '#28a745' : value >= 3 ? '#ffc107' : '#dc3545';
            }
            
            // Remover erro se existir
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        };
        
        // HOVER handler
        star._hoverHandler = function() {
            highlightStars(container, value);
        };
        
        // Anexar listeners
        star.addEventListener('click', star._clickHandler);
        star.addEventListener('mouseenter', star._hoverHandler);
    });
    
    // Mouse leave handler para o container
    container.addEventListener('mouseleave', function() {
        const currentValue = parseInt(hiddenInput.value) || 0;
        updateStarsVisual(container, currentValue);
    });
    
    // CORRE√á√ÉO CR√çTICA: Restaurar estado visual inicial baseado no valor do input
    const initialValue = parseInt(hiddenInput.value) || 0;
    if (initialValue > 0) {
        console.log(`üîÑ Restaurando estado visual para ${fieldName}: ${initialValue} estrelas`);
        updateStarsVisual(container, initialValue);
        
        // Atualizar display se existir
        if (ratingDisplay) {
            const ratingText = [
                '', 'Muito Insatisfeito', 'Insatisfeito', 'Neutro', 'Satisfeito', 'Muito Satisfeito'
            ];
            ratingDisplay.textContent = `${initialValue} estrela${initialValue > 1 ? 's' : ''} - ${ratingText[initialValue] || ''}`;
            ratingDisplay.style.color = initialValue >= 4 ? '#28a745' : initialValue >= 3 ? '#ffc107' : '#dc3545';
        }
    } else {
        // Garantir que estrelas come√ßem vazias visualmente
        updateStarsVisual(container, 0);
    }
}

function highlightStars(container, rating) {
    const stars = container.querySelectorAll('.star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.style.color = '#ffc107';
            star.style.transform = 'scale(1.1)';
        } else {
            star.style.color = '#ddd';
            star.style.transform = 'scale(1)';
        }
    });
}

function updateStarsVisual(container, rating) {
    const stars = container.querySelectorAll('.star');
    stars.forEach((star, index) => {
        star.classList.remove('filled');
        star.style.transform = 'scale(1)';
        
        if (index < rating) {
            star.classList.add('filled');
            star.style.color = '#ffc107';
        } else {
            star.style.color = '#ddd';
        }
    });
}

function startVisualStateMonitor(form) {
    // Monitor visual state every 2 seconds to ensure consistency
    const monitorInterval = setInterval(() => {
        const containers = form.querySelectorAll('.stars-container');
        
        containers.forEach(container => {
            const fieldName = container.getAttribute('data-field');
            const hiddenInput = document.getElementById(`input-${fieldName}`);
            
            if (hiddenInput && hiddenInput.value) {
                const currentValue = parseInt(hiddenInput.value);
                const filledStars = container.querySelectorAll('.star.filled').length;
                
                // Se o visual n√£o condiz com o valor, corrigir
                if (filledStars !== currentValue) {
                    console.log(`üîß Corrigindo estado visual de ${fieldName}: ${filledStars} ‚Üí ${currentValue}`);
                    updateStarsVisual(container, currentValue);
                }
            }
        });
    }, 2000);
    
    // Limpar monitor quando modal fechar
    const modal = document.getElementById('avaliacaoModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', () => {
            clearInterval(monitorInterval);
            console.log('üõë Monitor visual desativado');
        });
    }
}

function setupFormSubmission(form) {
    const submitBtn = document.getElementById('submitBtnUnified');
    const spinner = submitBtn.querySelector('.spinner-border');
    
    console.log('üìù Configurando envio do formul√°rio...');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        console.log('üì§ Processando envio do formul√°rio...');
        
        // Validar todos os campos
        if (!validateAllFields(form)) {
            console.log('‚ùå Valida√ß√£o falhou');
            return;
        }
        
        // UI de loading
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
        
        // Preparar dados
        const formData = new FormData(form);
        
        // Log dos dados para debug
        console.log('üìã Dados sendo enviados:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        
        // Enviar via AJAX
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            console.log(`üì® Resposta recebida: ${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üì¶ Resposta processada:', data);
            
            if (data.success) {
                console.log('‚úÖ Avalia√ß√£o enviada com sucesso!');
                
                // Mostrar sucesso
                showMessage('Avalia√ß√£o registrada com sucesso!', 'success');
                
                // Fechar modal ap√≥s delay
                setTimeout(() => {
                    closeModal();
                    // Recarregar p√°gina
                    window.location.reload();
                }, 1500);
                
            } else {
                console.error('‚ùå Erro no servidor:', data.message);
                showMessage(data.message || 'Erro ao processar avalia√ß√£o', 'error');
            }
        })
        .catch(error => {
            console.error('üí• Erro na requisi√ß√£o:', error);
            showMessage('Erro de conex√£o. Tente novamente.', 'error');
        })
        .finally(() => {
            // Restaurar UI
            submitBtn.disabled = false;
            spinner.classList.add('d-none');
        });
    });
}

function validateAllFields(form) {
    const containers = form.querySelectorAll('.stars-container[data-required="true"]');
    let isValid = true;
    
    containers.forEach(container => {
        const fieldName = container.getAttribute('data-field');
        const hiddenInput = document.getElementById(`input-${fieldName}`);
        const errorDiv = document.getElementById(`error-${fieldName}`);
        
        if (!hiddenInput.value) {
            isValid = false;
            if (errorDiv) {
                errorDiv.style.display = 'block';
            }
            console.log(`‚ùå Campo ${fieldName} n√£o preenchido`);
        } else {
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
    });
    
    return isValid;
}

function showMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show`;
    alert.innerHTML = `
        <i class="fas ${iconClass} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Inserir no in√≠cio do modal
    const modalBody = document.querySelector('#avaliacaoModal .modal-body');
    if (modalBody) {
        modalBody.insertBefore(alert, modalBody.firstChild);
    }
}

function closeModal() {
    const modal = document.getElementById('avaliacaoModal');
    if (modal && window.bootstrap) {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    }
}

// Auto-inicializa√ß√£o quando o script carrega
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', window.AvaliacaoUnificada.init);
} else {
    window.AvaliacaoUnificada.init();
}

// Exportar fun√ß√£o global para re-inicializa√ß√£o
window.initAvaliacaoUnificada = window.AvaliacaoUnificada.init;

console.log('üìù Sistema unificado carregado! Use window.initAvaliacaoUnificada() para re-inicializar.');
</script>