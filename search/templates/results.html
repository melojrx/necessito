{% extends "base.html" %}
{% load static %}

{% block title %}
{% if term %}"{{ term }}" ‚Äì {% endif %}An√∫ncios em {{ state }}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/search-modernization.css' %}?v=2025">
<style>
/* Modern Search Page - Mobile First CSS Variables */
:root {
    --primary-color: #0d6efd;
    --secondary-color: #6c757d;
    --success-color: #28a745;
    --info-color: #17a2b8;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --card-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    --card-shadow-hover: 0 1rem 2rem rgba(0, 0, 0, 0.25);
    --border-radius: 0.75rem;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
}

/* Progress bar */
.search-progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, #007bff, #00d4aa);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: 9999;
}

.search-progress-bar.active {
    animation: progressBar 2s ease-in-out infinite;
}

@keyframes progressBar {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(0%); }
    100% { transform: translateX(100%); }
}

/* Active Filters Desktop */
.active-filters-desktop .badge {
    display: inline-flex;
    align-items: center;
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
}

.active-filters-desktop .btn-close {
    width: 0.5em;
    height: 0.5em;
    opacity: 0.8;
}

.active-filters-desktop .btn-close:hover {
    opacity: 1;
}

/* Responsive container adjustments */
@media (max-width: 767px) {
    .container {
        padding: 0 16px;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Progress Bar Moderno -->
<div class="search-progress-bar" id="searchProgressBar"></div>

<!-- Search Header Component -->
{% include "components/_search_header.html" %}

<!-- Mobile Filters -->
{% include "components/_filters_mobile.html" %}

<!-- Main Content Container -->
<div class="container">
  <div class="row g-4">
    
    <!-- Desktop Filters Sidebar -->
    <aside class="col-lg-3 d-none d-lg-block">
      {% include "components/_filters_sidebar.html" %}
    </aside>
    
    <!-- Main Content Area -->
    <main class="col-12 col-lg-9">
      
      <!-- Active Filters Display (Desktop) -->
      <div class="d-none d-lg-block mb-4">
        {% if term or local or cliente or campos or status_selecionados|length > 1 or status_selecionados.0 != 'ativo' %}
        <div class="active-filters-desktop">
          <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
            <span class="text-muted fw-semibold me-2">
              <i class="fas fa-filter me-1"></i>
              Filtros ativos:
            </span>
            
            {% if term %}
            <span class="badge bg-primary text-white rounded-pill px-3 py-2">
              <i class="fas fa-search me-1"></i>
              "{{ term|truncatechars:30 }}"
              <button type="button" 
                      class="btn-close btn-close-white ms-2 small" 
                      onclick="removeDesktopFilter('q')"
                      aria-label="Remover busca"></button>
            </span>
            {% endif %}
            
            {% if local %}
            <span class="badge bg-success text-white rounded-pill px-3 py-2">
              <i class="fas fa-map-marker-alt me-1"></i>
              {{ local|truncatechars:20 }}
              <button type="button" 
                      class="btn-close btn-close-white ms-2 small" 
                      onclick="removeDesktopFilter('local')"
                      aria-label="Remover local"></button>
            </span>
            {% endif %}
            
            {% if cliente %}
            <span class="badge bg-info text-white rounded-pill px-3 py-2">
              <i class="fas fa-user me-1"></i>
              {{ cliente|truncatechars:15 }}
              <button type="button" 
                      class="btn-close btn-close-white ms-2 small" 
                      onclick="removeDesktopFilter('cliente')"
                      aria-label="Remover anunciante"></button>
            </span>
            {% endif %}
            
            {% for campo in campos %}
            <span class="badge bg-warning text-dark rounded-pill px-3 py-2">
              <i class="fas fa-crosshairs me-1"></i>
              {{ campo|title }}
              <button type="button" 
                      class="btn-close ms-2 small" 
                      onclick="removeDesktopFieldFilter('{{ campo }}')"
                      aria-label="Remover campo {{ campo }}"></button>
            </span>
            {% endfor %}
            
            {% if status_selecionados|length > 1 %}
            <span class="badge bg-secondary text-white rounded-pill px-3 py-2">
              <i class="fas fa-flag me-1"></i>
              {{ status_selecionados|length }} status
              <button type="button" 
                      class="btn-close btn-close-white ms-2 small" 
                      onclick="removeDesktopFilter('status')"
                      aria-label="Remover status"></button>
            </span>
            {% endif %}
            
            <a href="?state={{ state }}" 
               class="badge bg-light text-dark border rounded-pill px-3 py-2 text-decoration-none">
              <i class="fas fa-times me-1"></i>
              Limpar todos
            </a>
          </div>
        </div>
        {% endif %}
      </div>
      
      <!-- Search Results -->
      {% include "components/_search_results.html" %}
      
    </main>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Moderniza√ß√£o da busca - vers√£o simples -->
<script>
console.log('üöÄ Search Modernization Loading...');

document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ DOM Ready - Applying search modernization');
    
    // Progress bar em a√ß√µes
    const progressBar = document.getElementById('searchProgressBar');
    const forms = document.querySelectorAll('form');
    
    forms.forEach(form => {
        if (progressBar) {
            form.addEventListener('submit', function() {
                progressBar.classList.add('active');
            });
        }
    });
    
    // Auto-focus no campo de busca (mobile)
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput && !searchInput.value && window.innerWidth <= 768) {
        setTimeout(() => searchInput.focus(), 300);
    }
    
    console.log('‚úÖ Search modernization applied successfully');
});

// Desktop filter removal functions
window.removeDesktopFilter = function(filterType) {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.delete(filterType);
    window.location.href = currentUrl.toString();
};

window.removeDesktopFieldFilter = function(fieldValue) {
    const currentUrl = new URL(window.location);
    const campos = currentUrl.searchParams.getAll('campos');
    
    // Remove the specific field
    currentUrl.searchParams.delete('campos');
    campos.forEach(campo => {
        if (campo !== fieldValue) {
            currentUrl.searchParams.append('campos', campo);
        }
    });
    
    window.location.href = currentUrl.toString();
};
</script>

<!-- Carregar moderniza√ß√£o da busca -->
<script src="{% static 'js/search-modernization.js' %}?v=2025"></script>

<!-- Scripts Estado/Cidade (vers√£o simplificada e otimizada) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log('üèôÔ∏è Iniciando sistema Estado/Cidade - Mobile First');
    
    // Estados e principais cidades (vers√£o otimizada)
    const cidadesPorEstado = {
        'SP': ['S√£o Paulo', 'Guarulhos', 'Campinas', 'S√£o Bernardo do Campo', 'Santos', 'Osasco'],
        'RJ': ['Rio de Janeiro', 'S√£o Gon√ßalo', 'Duque de Caxias', 'Nova Igua√ßu', 'Niter√≥i'],
        'MG': ['Belo Horizonte', 'Uberl√¢ndia', 'Contagem', 'Juiz de Fora', 'Betim'],
        'RS': ['Porto Alegre', 'Caxias do Sul', 'Pelotas', 'Canoas', 'Santa Maria'],
        'PR': ['Curitiba', 'Londrina', 'Maring√°', 'Ponta Grossa', 'Cascavel'],
        'SC': ['Florian√≥polis', 'Joinville', 'Blumenau', 'S√£o Jos√©', 'Crici√∫ma'],
        'BA': ['Salvador', 'Feira de Santana', 'Vit√≥ria da Conquista', 'Cama√ßari'],
        'GO': ['Goi√¢nia', 'Aparecida de Goi√¢nia', 'An√°polis', 'Rio Verde'],
        'PE': ['Recife', 'Jaboat√£o dos Guararapes', 'Olinda', 'Caruaru'],
        'CE': ['Fortaleza', 'Caucaia', 'Juazeiro do Norte', 'Maracana√∫'],
        // Adicionar outros estados conforme necess√°rio
    };
    
    // Fun√ß√£o para atualizar cidades
    function atualizarCidades(estadoSelect, cidadeSelect, estado) {
        if (!cidadeSelect) return;
        
        cidadeSelect.innerHTML = '<option value="">Carregando...</option>';
        cidadeSelect.disabled = true;
        
        setTimeout(() => {
            if (estado === 'todos' || !estado) {
                cidadeSelect.innerHTML = '<option value="">Primeiro selecione um estado</option>';
                cidadeSelect.disabled = true;
                return;
            }
            
            const cidades = cidadesPorEstado[estado] || [];
            
            if (cidades.length === 0) {
                cidadeSelect.innerHTML = '<option value="">Estado sem cidades mapeadas</option>';
                cidadeSelect.disabled = true;
                return;
            }
            
            let html = '<option value="">Selecione uma cidade</option>';
            cidades.forEach(cidade => {
                html += `<option value="${cidade}">${cidade}</option>`;
            });
            
            cidadeSelect.innerHTML = html;
            cidadeSelect.disabled = false;
            
            console.log(`‚úÖ ${cidades.length} cidades carregadas para ${estado}`);
        }, 100);
    }
    
    // Desktop
    const estadoSelect = document.getElementById('estadoSelect');
    const cidadeSelect = document.getElementById('cidadeSelect');
    
    if (estadoSelect && cidadeSelect) {
        estadoSelect.addEventListener('change', (e) => {
            atualizarCidades(estadoSelect, cidadeSelect, e.target.value);
        });
        
        // Carregar estado inicial
        if (estadoSelect.value && estadoSelect.value !== 'todos') {
            atualizarCidades(estadoSelect, cidadeSelect, estadoSelect.value);
        }
    }
    
    // Mobile
    const estadoSelectMobile = document.getElementById('estadoSelectMobile');
    const cidadeSelectMobile = document.getElementById('cidadeSelectMobile');
    
    if (estadoSelectMobile && cidadeSelectMobile) {
        estadoSelectMobile.addEventListener('change', (e) => {
            atualizarCidades(estadoSelectMobile, cidadeSelectMobile, e.target.value);
        });
        
        // Carregar estado inicial mobile
        if (estadoSelectMobile.value && estadoSelectMobile.value !== 'todos') {
            atualizarCidades(estadoSelectMobile, cidadeSelectMobile, estadoSelectMobile.value);
        }
    }
    
    console.log('‚úÖ Sistema Estado/Cidade inicializado com sucesso');
});

// Fun√ß√£o de geolocaliza√ß√£o simplificada
window.usarLocalizacaoAtual = function() {
    const btn = document.getElementById('btn-localizacao');
    if (!btn || !navigator.geolocation) {
        alert('Geolocaliza√ß√£o n√£o suportada');
        return;
    }
    
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            console.log('üìç Localiza√ß√£o obtida:', position.coords);
            // Aqui voc√™ pode implementar a l√≥gica de busca por coordenadas
            btn.innerHTML = originalContent;
            btn.disabled = false;
        },
        function() {
            alert('N√£o foi poss√≠vel obter sua localiza√ß√£o');
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    );
};
</script>
{% endblock %}