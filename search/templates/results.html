{% extends "base.html" %}
{% load static %}

{% block title %}
  {% if term %}“{{ term }}” – {% endif %}Anúncios em {{ state }}
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="row">

    {# ------------- MENU LATERAL ------------- #}
    {% if request.resolver_match.url_name == 'necessidade_search_all' %}
    <aside class="col-lg-2 d-none d-lg-block pe-0">
      <ul class="list-group sticky-top" style="top:80px;">
        {% for cat in menu_categorias %}
        <li class="list-group-item border-0 py-2">
          <a href="{% url 'search:necessidade_search_all' %}?q={{ cat.nome }}&state={{ state }}"
             class="d-flex align-items-center text-decoration-none text-dark small">
            {% if cat.imagem %}
              <img src="{{ cat.imagem }}" alt="" width="20" class="me-2">
            {% else %}
              <i class="fas fa-tag me-2 text-secondary"></i>
            {% endif %}
            {{ cat.nome }}
          </a>
        </li>
        {% endfor %}
      </ul>
    </aside>
    {% endif %}

    <!-- ============ LISTA DE RESULTADOS ============ -->
    <main class="col-12 {% if menu_categorias %}col-lg-10{% endif %}">

      <h2 class="h4 fw-semibold mb-1">
        {% if term %}Resultados para “{{ term }}”{% else %}Todos os anúncios{% endif %}
        em {{ state }}
      </h2>
      <p class="small text-muted mb-3">
        {{ page_obj.start_index }} – {{ page_obj.end_index }}
        de {{ page_obj.paginator.count }} resultados
      </p>

      <!-- grade -->
      {% if anuncios %}
      <div class="row g-3">
        {% for ad in anuncios %}
        <div class="col-6 col-md-4 col-xl-3">
          <a href="{{ ad.get_absolute_url }}" class="text-decoration-none">
            <div class="card h-100 shadow-sm border-0 listing-card">

              {# primeira imagem ou placeholder #}
              {% with img=ad.imagens.all.0 %}
                {% if img %}
                  <img src="{{ img.imagem.url }}" class="card-img-top"
                       style="height:180px;object-fit:cover;" alt="{{ ad.titulo }}">
                {% else %}
                  <img src="{% static 'img/placeholder.png' %}" class="card-img-top"
                       style="height:180px;object-fit:cover;" alt="">
                {% endif %}
              {% endwith %}

              <div class="card-body px-2 py-3">
                <h3 class="fs-6 fw-semibold text-truncate mb-1">{{ ad.titulo }}</h3>
                <p class="small mb-2 text-muted">
                  {{ ad.cliente.estado|upper }} • {{ ad.data_criacao|date:"d M Y" }}
                </p>
                <span class="badge bg-light text-primary fw-normal">
                  {{ ad.quantidade }} {{ ad.get_unidade_display }}
                </span>
              </div>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <div class="alert alert-warning">Nenhum anúncio encontrado.</div>
      {% endif %}

      <!-- paginação -->
      {% if is_paginated %}
      <nav class="mt-4">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?q={{ term }}&state={{ state }}&page={{ page_obj.previous_page_number }}">&laquo;</a>
            </li>
          {% endif %}
          {% for num in paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
              <li class="page-item">
                <a class="page-link"
                   href="?q={{ term }}&state={{ state }}&page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?q={{ term }}&state={{ state }}&page={{ page_obj.next_page_number }}">&raquo;</a>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

    </main>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.listing-card:hover { box-shadow:0 0.5rem 1rem rgba(0,0,0,.15); }
</style>
{% endblock %}
