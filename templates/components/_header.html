{% load static %}
{% load chat_tags %}

<header>
<!-- CSS INLINE MODERNO - HEADER PROFISSIONAL -->
<style>
/* ===== HEADER MODERNO - DESIGN SYSTEM UNIFICADO ===== */

/* Header com gradiente sutil */
.navbar {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%) !important;
    border-bottom: 1px solid #e8eaed !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08) !important;
    padding: 0.75rem 0 !important;
    min-height: 70px !important;
}

/* Logo modernizado */
.navbar-brand {
    display: flex !important;
    align-items: center !important;
    font-weight: 700 !important;
    color: #2c3e50 !important;
    text-decoration: none !important;
    transition: all 0.3s ease !important;
}

.navbar-brand:hover {
    color: #0d6efd !important;
    transform: translateY(-1px) !important;
}

.navbar-brand img {
    height: 50px !important;
    margin-right: 12px !important;
    transition: all 0.3s ease !important;
}

.navbar-brand:hover img {
    transform: scale(1.05) !important;
}

.navbar-brand span {
    font-size: 1.75rem !important;
    font-weight: 700 !important;
    background: linear-gradient(135deg, #0d6efd 0%, #6f42c1 100%) !important;
    -webkit-background-clip: text !important;
    background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
}

/* ===== BARRA DE BUSCA ULTRA MODERNA ===== */
.search-bar {
    border: 2px solid #e8eaed !important;
    background: white !important;
    transition: all 0.3s ease !important;
    border-radius: 50px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08) !important;
    padding: 6px !important;
    display: flex !important;
    align-items: center !important;
    min-height: 52px !important;
    position: relative !important;
    overflow: hidden !important;
}

.search-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, #0d6efd 0%, #6f42c1 50%, #20c997 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.search-bar:focus-within {
    border-color: #0d6efd !important;
    box-shadow: 0 6px 20px rgba(13, 110, 253, 0.2) !important;
    transform: translateY(-2px) !important;
}

.search-bar:focus-within::before {
    transform: scaleX(1);
}

.search-bar input {
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    background: transparent !important;
    padding: 14px 20px !important;
    font-size: 1rem !important;
    flex: 1 !important;
    font-weight: 500 !important;
    color: #2c3e50 !important;
}

.search-bar input::placeholder {
    color: #6c757d !important;
    font-weight: 400 !important;
}

.search-divider {
    width: 1px !important;
    height: 30px !important;
    background: linear-gradient(180deg, transparent 0%, #dee2e6 50%, transparent 100%) !important;
    margin: 0 12px !important;
}

/* Dropdown de localização modernizado */
.search-location-dropdown {
    display: flex !important;
    align-items: center !important;
    padding: 10px 16px !important;
    border-radius: 25px !important;
    transition: all 0.3s ease !important;
    border: none !important;
    background: transparent !important;
    min-width: 140px !important;
    font-weight: 500 !important;
    color: #2c3e50 !important;
}

.search-location-dropdown:hover {
    background: rgba(13, 110, 253, 0.08) !important;
    color: #0d6efd !important;
}

.search-location-dropdown i {
    color: #0d6efd !important;
    margin-right: 8px !important;
    font-size: 1rem !important;
}

/* Botão de busca com gradiente */
.search-submit-btn {
    background: linear-gradient(135deg, #0d6efd 0%, #6f42c1 100%) !important;
    border: none !important;
    border-radius: 50% !important;
    width: 44px !important;
    height: 44px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: white !important;
    transition: all 0.3s ease !important;
    margin-right: 4px !important;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3) !important;
}

.search-submit-btn:hover {
    transform: scale(1.1) rotate(5deg) !important;
    box-shadow: 0 6px 18px rgba(13, 110, 253, 0.4) !important;
}

.search-submit-btn i {
    font-size: 1.1rem !important;
}

/* ===== MENU ITEMS MODERNOS ===== */
.navbar-nav .nav-link {
    display: flex !important;
    align-items: center !important;
    padding: 12px 16px !important;
    border-radius: 12px !important;
    transition: all 0.3s ease !important;
    font-weight: 500 !important;
    color: #2c3e50 !important;
    margin: 0 4px !important;
    position: relative !important;
    text-decoration: none !important;
}

.navbar-nav .nav-link:hover {
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 100%) !important;
    color: #0d6efd !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15) !important;
}

.navbar-nav .nav-link i {
    margin-right: 8px !important;
    font-size: 1.1rem !important;
    transition: all 0.3s ease !important;
}

.navbar-nav .nav-link:hover i {
    transform: scale(1.1) !important;
}

/* Badge de notificações moderno */
.badge {
    background: linear-gradient(135deg, #dc3545 0%, #e91e63 100%) !important;
    border: 2px solid white !important;
    font-size: 0.7rem !important;
    font-weight: 600 !important;
    min-width: 20px !important;
    height: 20px !important;
    border-radius: 10px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* ===== BOTÃO ANUNCIAR PREMIUM ===== */
.btn-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #6f42c1 100%) !important;
    border: none !important;
    border-radius: 50px !important;
    padding: 14px 28px !important;
    font-weight: 600 !important;
    font-size: 1rem !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3) !important;
    min-width: 180px !important;
    height: 50px !important;
}

.btn-primary:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 8px 25px rgba(13, 110, 253, 0.4) !important;
    background: linear-gradient(135deg, #6f42c1 0%, #0d6efd 100%) !important;
}

.btn-primary i {
    margin-right: 8px !important;
    font-size: 1rem !important;
}

/* ===== DROPDOWN MODERNIZADO ===== */
.dropdown-menu {
    border: none !important;
    border-radius: 16px !important;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    padding: 12px 0 !important;
    margin-top: 8px !important;
    background: white !important;
    backdrop-filter: blur(10px) !important;
}

.dropdown-item {
    padding: 12px 20px !important;
    transition: all 0.3s ease !important;
    font-weight: 500 !important;
    color: #2c3e50 !important;
    border-radius: 8px !important;
    margin: 2px 8px !important;
}

.dropdown-item:hover {
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 100%) !important;
    color: #0d6efd !important;
    transform: translateX(4px) !important;
}

.dropdown-item.active {
    background: linear-gradient(135deg, #0d6efd 0%, #6f42c1 100%) !important;
    color: white !important;
}

.dropdown-item i {
    margin-right: 12px !important;
    width: 16px !important;
    text-align: center !important;
}

.dropdown-divider {
    margin: 8px 16px !important;
    border-top: 1px solid #e8eaed !important;
}

/* ===== OFFCANVAS NOTIFICAÇÕES MODERNO ===== */
.offcanvas-header {
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 100%) !important;
    border-bottom: 1px solid #e8eaed !important;
    padding: 20px 24px !important;
}

.offcanvas-title {
    color: #0d6efd !important;
    font-weight: 700 !important;
    font-size: 1.25rem !important;
}

.offcanvas-title i {
    margin-right: 12px !important;
}

.btn-close {
    background-size: 16px !important;
    opacity: 0.7 !important;
    transition: all 0.3s ease !important;
}

.btn-close:hover {
    opacity: 1 !important;
    transform: scale(1.1) !important;
}

/* ===== RESPONSIVIDADE MOBILE ===== */
@media (max-width: 767px) {
    .navbar {
        padding: 12px 0 !important;
        min-height: 65px !important;
    }
    
    .navbar-brand img {
        height: 40px !important;
        margin-right: 8px !important;
    }
    
    .navbar-brand span {
        font-size: 1.4rem !important;
    }
    
    /* Hamburger moderno */
    .navbar-toggler {
        border: none !important;
        padding: 8px !important;
        border-radius: 8px !important;
        transition: all 0.3s ease !important;
    }
    
    .navbar-toggler:hover {
        background: rgba(13, 110, 253, 0.1) !important;
        transform: scale(1.05) !important;
    }
    
    .navbar-toggler:focus {
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2) !important;
    }
    
    /* Menu mobile expandido */
    .navbar-collapse.show {
        background: white !important;
        border-radius: 16px !important;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        margin-top: 12px !important;
        padding: 16px !important;
    }
    
    .navbar-collapse.show .search-container {
        width: 100% !important;
        margin: 16px 0 !important;
    }
    
    .navbar-collapse.show .search-bar {
        width: 100% !important;
        min-height: 48px !important;
    }
    
    /* Simplificar busca mobile */
    .search-divider,
    .search-location-dropdown {
        display: none !important;
    }
    
    .search-submit-btn {
        width: 40px !important;
        height: 40px !important;
        margin-right: 0 !important;
    }
    
    /* Menu items mobile */
    .navbar-nav .nav-link {
        padding: 14px 16px !important;
        font-size: 1rem !important;
        margin: 4px 0 !important;
        border-radius: 12px !important;
    }
    
    .mobile-text-small {
        font-size: 1rem !important;
        margin-left: 0 !important;
    }
}

/* ===== ANIMAÇÕES ===== */
.bell-animation {
    animation: bellShake 2s infinite !important;
    transform-origin: top center !important;
}

@keyframes bellShake {
    0% { transform: rotate(0); }
    15% { transform: rotate(5deg); }
    30% { transform: rotate(-5deg); }
    45% { transform: rotate(4deg); }
    60% { transform: rotate(-4deg); }
    75% { transform: rotate(2deg); }
    85% { transform: rotate(-2deg); }
    92% { transform: rotate(1deg); }
    100% { transform: rotate(0); }
}

/* Loading spinner moderno */
.loading-spinner {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    height: 200px !important;
}

.loading-spinner .spinner {
    width: 40px !important;
    height: 40px !important;
    border: 4px solid rgba(13, 110, 253, 0.1) !important;
    border-radius: 50% !important;
    border-top: 4px solid #0d6efd !important;
    animation: spin 1s linear infinite !important;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<nav class="navbar navbar-expand-lg bg-body-tertiary py-2 py-lg-3">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
        <img src="{% static 'img/logo2.png' %}" alt="indicaai.br" height="80" class="d-inline-block align-top me-2">
  
        <!-- MOBILE: Logo mais próximo do design -->
        <span class="d-block d-lg-none"
            style="font-size: 2rem; font-weight: 700; color: #2c3e50; font-family: 'Segoe UI', 'Roboto', sans-serif; margin-top: 0.2rem;">
        Indicaai
        </span>

  
        <!-- Nome no DESKTOP -->
        <span class="fs-3 fw-semibold d-none d-lg-block" style="color: #545b62;">Indicaai</span>
      </a>
  
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
  
      <div class="collapse navbar-collapse mt-2 mt-lg-0" id="navbarNav">
        <ul class="navbar-nav me-auto align-items-start">
          <li class="nav-item flex-grow-1 me-auto search-container">
            <form method="get" action="{% url 'search:necessidade_search_all' %}" class="w-100">
              <input type="hidden" name="state" id="stateInput" value="{{ selected_state|default:'todos' }}">
              <div class="search-bar">
                <input type="text" name="q" class="flex-grow-1"
                  placeholder='Buscar por produtos, serviços...' value="{{ request.GET.q|default:'' }}" autocomplete="off">
                
                <!-- Divisor e dropdown de estado (apenas desktop) -->
                <div class="search-divider d-none d-md-block"></div>
                <div class="dropdown d-none d-md-block">
                  <button class="search-location-dropdown dropdown-toggle" type="button"
                    data-bs-toggle="dropdown" aria-expanded="false" id="stateButton">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ selected_state|default:'Todos os estados' }}</span>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0" aria-labelledby="stateButton" style="border-radius: 12px;">
                    <li><a class="dropdown-item {% if selected_state == 'todos' %}active{% endif %}" href="#" data-state="todos">
                      <i class="fas fa-globe me-2 text-primary"></i> Todos os estados
                    </a></li>
                    {% for st in states %}
                    <li><a class="dropdown-item {% if selected_state == st.abbreviation %}active{% endif %}"
                        href="#" data-state="{{ st.abbreviation }}">
                        <i class="fas fa-map-marker-alt me-2 text-secondary"></i> {{ st.abbreviation }}
                    </a></li>
                    {% endfor %}
                  </ul>
                </div>
                
                <button class="search-submit-btn" type="submit" aria-label="Pesquisar">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </form>
          </li>
        </ul>
  
        <ul class="navbar-nav ms-auto align-items-start justify-content-end mt-2 mt-lg-0">
          <li class="nav-item">
            <a href="{% url 'help' %}" class="nav-link d-flex align-items-center">
              <i class="fas fa-question-circle me-2"></i>
              <span class="d-none d-md-inline d-lg-inline">Ajuda</span>
              <span class="d-block d-md-none mobile-text-small">Ajuda</span>
            </a>
          </li>
          <li class="nav-item position-relative">
            <button class="btn btn-link nav-link d-flex align-items-center" type="button" data-bs-toggle="offcanvas"
              data-bs-target="#offcanvasNotifications">
              <i class="fas fa-bell me-2 {% if unread_notifications_count > 0 %}bell-animation{% endif %}"></i>
              <span class="d-none d-md-inline d-lg-inline">Notificações</span>
              <span class="d-block d-md-none mobile-text-small">Notificações</span>
              {% if unread_notifications_count > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ unread_notifications_count }}
              </span>
              {% endif %}
            </button>
          </li>

          {% if user.is_authenticated %}
          <li class="nav-item dropdown mb-2">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-user me-2 d-lg-none"></i>
                <span class="d-none d-md-inline d-lg-inline">Olá, {{ user.first_name|capfirst }}!</span>
                <span class="d-block d-md-none mobile-text-small">{{ user.first_name|capfirst|truncatechars:8 }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="{% url 'minha_conta_detail' user.pk %}"><i class="fas fa-user"></i> Minha Conta</a></li>
              <li><a class="dropdown-item" href="{% url 'necessidade_list' %}"><i class="fas fa-bullhorn"></i> Meus Anúncios</a></li>
              <li><a class="dropdown-item" href="{% url 'budget_list' %}"><i class="far fa-list-alt"></i> Meus Orçamentos</a></li>
              <li> <!-- LINK DO CHAT COM CONTADOR -->
                <a class="dropdown-item d-flex align-items-center justify-content-between" href="{% url 'chat:lista_chats' %}">
                    <span>
                        <i class="fas fa-comments me-2"></i> Chats
                    </span>
                    {% if unread_messages_count > 0 %}
                        <span class="badge rounded-pill bg-danger ms-2">
                            {{ unread_messages_count }}
                            <span class="visually-hidden">mensagens não lidas</span>
                        </span>
                    {% endif %}
                </a></li>
              {% if user.is_staff %}
              <li><a class="dropdown-item" href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
              {% endif %}
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
            </ul>
          </li>
          {% else %}
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center" href="{% url 'login' %}">
              <i class="fas fa-sign-in-alt me-2"></i> 
              <span class="d-none d-md-inline d-lg-inline">Login</span>
              <span class="d-block d-md-none mobile-text-small">Login</span>
            </a>
          </li>
          <li class="nav-item ms-lg-3">
            <a class="nav-link d-flex align-items-center" href="{% url 'register' %}">
              <i class="fas fa-user-plus me-2"></i> 
              <span class="d-none d-md-inline d-lg-inline">Registrar</span>
              <span class="d-block d-md-none mobile-text-small">Cadastrar</span>
            </a>
          </li>
          {% endif %}
  
          <!-- Botão Anunciar: Oculto no mobile (temos FAB), visível no desktop -->
          <li class="nav-item ms-lg-3 d-none d-lg-block">
            <a href="{% url 'necessidade_create' %}" class="btn btn-primary text-white px-4 py-2 rounded-pill d-flex align-items-center justify-content-center" style="font-size: 14px; height: 45px; min-width: 180px;">
              <i class="fas fa-bullhorn me-2"></i> Anunciar grátis
            </a>
          </li>
        </ul>
      </div>
    </div>
</nav>
  
    <!-- Off Canvas Notificações -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifications" aria-labelledby="offcanvasNotificationsLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasNotificationsLabel" style="color: #0B5ED7;">
                <i class="fa-solid fa-bell"></i> Notificações
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            {% if user.is_authenticated %}
                <div class="d-flex justify-content-end mb-3">
                    <a href="{% url 'notification_mark_all_read' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-check-double me-1"></i> Marcar todas como lidas
                    </a>
                </div>
                
                <!-- Container para as notificações -->
                <div class="list-group" id="notifications-container">
                    <!-- As notificações serão carregadas aqui via AJAX -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Link para ver todas - removido temporariamente -->
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i> 
                        Mostrando as 5 notificações mais recentes
                    </small>
                </div>
                
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-user-lock fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Faça login para ver suas notificações.</p>
                    <a href="{% url 'login' %}" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt me-1"></i> Fazer Login
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

</header>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.querySelector('.search-bar input[name="q"]');
        const stateInput = document.getElementById('stateInput');
        const stateButton = document.getElementById('stateButton');
        const stateDropdown = document.querySelectorAll('.dropdown-item[data-state]');

        // Atualizar estado selecionado
        stateDropdown.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedState = this.getAttribute('data-state');
                const stateName = selectedState === 'todos' ? 'Todos os estados' : selectedState;
                
                stateInput.value = selectedState;
                
                // Atualizar o texto do botão
                const buttonText = stateButton.querySelector('span');
                if (buttonText) {
                    buttonText.textContent = stateName;
                }
                
                // Remover classe active de todos
                stateDropdown.forEach(dropdown => dropdown.classList.remove('active'));
                // Adicionar classe active ao selecionado
                this.classList.add('active');
            });
        });

        // Carregar notificações quando o offcanvas for aberto
        const notificationsOffcanvas = document.getElementById('offcanvasNotifications');
        if (notificationsOffcanvas) {
            notificationsOffcanvas.addEventListener('shown.bs.offcanvas', function () {
                loadNotifications();
            });
        }

        function loadNotifications() {
            const container = document.getElementById('notifications-container');
            if (!container) return;

            fetch('{% url "get_notifications" %}')
                .then(response => response.json())
                .then(data => {
                    // A view retorna HTML renderizado
                    container.innerHTML = data.html;
                })
                .catch(error => {
                    console.error('Erro ao carregar notificações:', error);
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                            <p class="text-muted">Erro ao carregar notificações.</p>
                        </div>
                    `;
                });
        }
    });
</script>