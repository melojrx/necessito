{% load static %}

<style>
:root {
    /* Design System 2025 Variables */
    --primary-color: #007BFF;
    --primary-gradient: linear-gradient(135deg, #007BFF 0%, #0056b3 100%);
    --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --accent-gradient: linear-gradient(135deg, #007BFF 0%, #0056b3 100%);
    
    --glass-bg: rgba(255, 255, 255, 0.25);
    --glass-border: rgba(255, 255, 255, 0.18);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    
    --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    --shadow-medium: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
    --shadow-strong: 0 16px 48px 0 rgba(31, 38, 135, 0.55);
    
    --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-elastic: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    
    --text-dark: #2d3748;
    --text-light: #718096;
    --text-accent: #007BFF;
}

/* Modern Header Styles */
.modern-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1030;
    background: #ffffff;
    border-bottom: 1px solid #e2e8f0;
    box-shadow: var(--shadow-soft);
    transition: var(--transition-smooth);
}

.modern-header.scrolled {
    background: #ffffff;
    box-shadow: var(--shadow-medium);
}

/* Logo modernizado */
.modern-logo {
    display: flex;
    align-items: center;
    text-decoration: none;
    transition: var(--transition-smooth);
}

.modern-logo:hover {
    transform: scale(1.02);
    filter: brightness(1.1);
}

.modern-logo img {
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
    transition: var(--transition-smooth);
}

.modern-logo-text {
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
    font-size: 1.75rem;
    margin-left: 0.5rem;
}

/* Search Bar Premium */
.search-container {
    position: relative;
    flex-grow: 1;
    max-width: 600px;
    z-index: 1020;
}

.modern-search-bar {
    background: #ffffff;
    border: 2px solid #e2e8f0;
    border-radius: 25px;
    padding: 0.75rem 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: var(--transition-smooth);
    position: relative;
    overflow: hidden;
}

.modern-search-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--primary-gradient);
    opacity: 0;
    transition: var(--transition-smooth);
    z-index: -1;
}

.modern-search-bar:focus-within {
    border-color: #007BFF;
    box-shadow: 0 8px 30px rgba(0, 123, 255, 0.25);
    transform: translateY(-2px);
}

.modern-search-bar:focus-within::before {
    opacity: 0.05;
}

.search-input {
    border: none;
    background: transparent;
    font-size: 1rem;
    color: var(--text-dark);
    flex-grow: 1;
    padding: 0;
}

.search-input::placeholder {
    color: var(--text-light);
    font-weight: 400;
}

.search-input:focus {
    outline: none;
    box-shadow: none;
}

/* Estilos removidos - seletor de estados não é mais usado */

.search-btn {
    background: var(--primary-color);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    transition: var(--transition-elastic);
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
}

.search-btn:hover {
    background: #0056b3;
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
}

/* Navigation Items */
.nav-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.notification-btn {
    position: relative;
    background: transparent;
    border: none;
    padding: 0.75rem;
    border-radius: 50%;
    transition: var(--transition-smooth);
    color: var(--text-light);
}

.notification-btn:hover {
    background: rgba(0, 123, 255, 0.1);
    color: var(--text-accent);
    transform: scale(1.1);
}

.notification-badge {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    background: var(--secondary-gradient);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.user-dropdown {
    position: relative;
    z-index: 1030;
}

.user-dropdown .dropdown-menu {
    z-index: 1060 !important;
    position: absolute !important;
}

.user-btn {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 25px;
    padding: 0.5rem 1rem;
    color: var(--text-dark);
    font-weight: 500;
    transition: var(--transition-smooth);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.user-btn:hover {
    background: #f8f9fa;
    border-color: #007BFF;
    color: var(--text-accent);
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.auth-links {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.auth-link {
    color: var(--text-light);
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    transition: var(--transition-smooth);
    font-weight: 500;
}

.auth-link:hover {
    color: var(--text-accent);
    background: rgba(0, 123, 255, 0.1);
    transform: translateY(-1px);
}

.cta-button {
    background: var(--primary-color);
    color: white;
    text-decoration: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    transition: var(--transition-elastic);
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    position: relative;
    overflow: hidden;
}

.cta-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.6s;
}

.cta-button:hover::before {
    left: 100%;
}

.cta-button:hover {
    background: #0056b3;
    color: white;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
}


/* Dropdown moderno */
.dropdown-menu {
    background: #ffffff !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 15px !important;
    box-shadow: var(--shadow-medium) !important;
    padding: 0.5rem !important;
    margin-top: 0.5rem !important;
    z-index: 1060 !important;
    position: absolute !important;
    min-width: 200px !important;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease !important;
}

.dropdown-menu.show {
    opacity: 1 !important;
    transform: translateY(0) !important;
    display: block !important;
}

.dropdown-item {
    border-radius: 10px;
    padding: 0.75rem 1rem;
    transition: var(--transition-smooth);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.dropdown-item:hover {
    background: rgba(0, 123, 255, 0.1);
    color: var(--text-accent);
    transform: translateX(3px);
}

.dropdown-item.active {
    background: var(--primary-gradient);
    color: white;
}

/* Offcanvas moderno */
.offcanvas {
    background: #ffffff;
}

.offcanvas-header {
    border-bottom: 1px solid #e2e8f0;
    background: var(--primary-gradient);
    color: white;
}

.notification-item {
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 0.5rem;
    transition: var(--transition-smooth);
}

.notification-item:hover {
    background: rgba(0, 123, 255, 0.05);
    transform: translateX(3px);
}

.notification-item.unread {
    background: rgba(0, 123, 255, 0.1);
    border-left: 4px solid #007BFF;
}

/* Responsividade */
@media (max-width: 991.98px) {
    .modern-search-bar {
        margin: 1rem 0;
    }
    
    .nav-actions {
        width: 100%;
        justify-content: space-between;
        margin-top: 1rem;
    }
}

@media (max-width: 576px) {
    .modern-logo-text {
        font-size: 1.5rem;
    }
    
    .search-container {
        max-width: 100%;
    }
}

/* Animações de entrada */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modern-header * {
    animation: fadeInUp 0.6s ease-out;
}

/* Body offset para header fixo - já definido no base.html */

/* Dropdown coordination styles - removido, já definido acima */

/* Mobile dropdown optimization */
@media (max-width: 768px) {
    .user-dropdown .dropdown-menu {
        min-width: 250px;
        max-width: 90vw;
        right: 10px !important;
        left: auto !important;
    }
    
    .dropdown-item {
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
    }
    
    /* Garantir que dropdown não interfira com conteúdo */
    .dropdown-menu.show {
        transform: translateY(0) !important;
    }
}
</style>

<header class="modern-header" id="modernHeader">
    <nav class="navbar navbar-expand-lg py-3">
        <div class="container">
            <!-- Logo modernizado -->
            <a class="modern-logo" href="{% url 'ads:home' %}">
                <img src="{% static 'img/logo2.png' %}" alt="Indicaai" height="50" class="d-inline-block align-top">
                <span class="modern-logo-text">Indicaai</span>
            </a>

            <!-- Menu hambúrguer SEMPRE visível em mobile -->
            <div class="d-lg-none">
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenuOffcanvas" aria-controls="mobileMenuOffcanvas">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>


            <!-- Menu principal desktop -->
            <div class="d-none d-lg-flex flex-grow-1 align-items-center justify-content-between ms-4">
                
                <!-- Barra de pesquisa premium -->
                <div class="search-container">
                    <form method="get" action="{% url 'search:necessidade_search_all' %}">
                        <div class="modern-search-bar d-flex align-items-center">
                            <input type="text"
                                   name="q"
                                   class="search-input"
                                   id="dynamicSearchInput"
                                   placeholder="Buscar Apartamento"
                                   value="{{ request.GET.q|default:'' }}"
                                   autocomplete="off">
                            
                            <button class="search-btn" type="submit" aria-label="Pesquisar">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Ações de navegação -->
                <div class="nav-actions">
                    

                    <!-- Notificações -->
                    <button class="notification-btn" type="button" data-bs-toggle="offcanvas"
                            data-bs-target="#offcanvasNotifications" aria-controls="offcanvasNotifications">
                        <i class="fas fa-bell"></i>
                        {% if unread_notifications_count > 0 %}
                        <span class="notification-badge">{{ unread_notifications_count }}</span>
                        {% endif %}
                    </button>

                    {% if user.is_authenticated %}
                    <!-- Dropdown do usuário -->
                    <div class="user-dropdown dropdown ms-2">
                        <button class="user-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="userDropdownBtn">
                            <i class="fas fa-user"></i>
                            <span>Olá, {{ user.first_name|capfirst }}!</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdownBtn">
                            <li>
                                <a class="dropdown-item" href="{% url 'users:minha_conta_detail' user.pk %}">
                                    <i class="fas fa-user"></i> Minha Conta
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'ads:necessidade_list' %}">
                                    <i class="fas fa-bullhorn"></i> Meus Anúncios
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'budgets:budget_list' %}">
                                    <i class="far fa-list-alt"></i> Meus Orçamentos
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'ads:disputa_list' %}">
                                    <i class="fas fa-balance-scale"></i> Minhas Disputas
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'ads:dashboard' %}">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                            </li>
                            {% if user.is_staff %}
                            <li>
                                <a class="dropdown-item" href="{% url 'admin_panel:dashboard' %}">
                                    <i class="fas fa-cogs"></i> Configurações
                                </a>
                            </li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="{% url 'users:logout' %}">
                                    <i class="fas fa-sign-out-alt"></i> Sair
                                </a>
                            </li>
                        </ul>
                    </div>
                    {% else %}
                    <!-- Links de autenticação -->
                    <div class="auth-links">
                        <a class="auth-link" href="{% url 'users:login' %}">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                        <a class="auth-link" href="{% url 'users:register' %}">
                            <i class="fas fa-user-plus"></i> Registrar
                        </a>
                    </div>
                    {% endif %}

                    <!-- CTA Button -->
                    <a href="{% url 'ads:necessidade_create' %}" class="cta-button">
                        <i class="fas fa-bullhorn"></i>
                        <span>Anunciar grátis</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>
</header>


<!-- Offcanvas Notificações Modernizado -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifications">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">
            <i class="fas fa-bell"></i> Notificações
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        {% if user.is_authenticated %}
            {% with user.notifications.all as user_notifications %}
                {% if user_notifications %}
                    <div class="list-group">
                        {% for notificacao in user_notifications %}
                            <div class="notification-item {% if not notificacao.is_read %}unread{% endif %}">
                                <div class="d-flex w-100 justify-content-between mb-2">
                                    <div>{{ notificacao.message|safe }}</div>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> {{ notificacao.created_at|timesince }} atrás
                                    </small>
                                </div>
                                <div class="d-flex gap-2">
                                    {% if notificacao.necessidade %}
                                    <a href="{% url 'ads:necessidade_detail' notificacao.necessidade.id %}" 
                                       class="btn btn-sm btn-primary">
                                        <i class="fas fa-bullhorn"></i> Ver Anúncio
                                    </a>
                                    {% endif %}
                                    {% if not notificacao.is_read %}
                                    <a href="{% url 'notification_mark_read' notificacao.id %}" 
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-check"></i> Marcar como lido
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Você não tem notificações.</p>
                    </div>
                {% endif %}
            {% endwith %}
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-user-lock fa-3x text-muted mb-3"></i>
                <p class="text-muted">Você precisa estar logado para ver notificações.</p>
                <a href="{% url 'users:login' %}" class="btn btn-primary">Fazer Login</a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Offcanvas Menu Mobile Universal -->
<div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="mobileMenuOffcanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">
            {% if user.is_authenticated %}
                <i class="fas fa-user me-2"></i>Olá, {{ user.first_name|capfirst|default:user.email }}!
            {% else %}
                <i class="fas fa-bars me-2"></i>Menu
            {% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        {% if user.is_authenticated %}
            <!-- Menu para usuários logados -->
            <ul class="list-group list-group-flush">
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center" href="{% url 'users:minha_conta_detail' user.pk %}">
                        <i class="fas fa-user me-3"></i>Minha Conta
                    </a>
                </li>
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center" href="{% url 'ads:necessidade_list' %}">
                        <i class="fas fa-bullhorn me-3"></i>Meus Anúncios
                    </a>
                </li>
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center" href="{% url 'budgets:budget_list' %}">
                        <i class="far fa-list-alt me-3"></i>Meus Orçamentos
                    </a>
                </li>
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center" href="{% url 'ads:disputa_list' %}">
                        <i class="fas fa-balance-scale me-3"></i>Minhas Disputas
                    </a>
                </li>
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center" href="{% url 'ads:dashboard' %}">
                        <i class="fas fa-tachometer-alt me-3"></i>Dashboard
                    </a>
                </li>
                {% if user.is_staff %}
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center" href="{% url 'admin_panel:dashboard' %}">
                        <i class="fas fa-cogs me-3"></i>Configurações
                    </a>
                </li>
                {% endif %}
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center text-danger" href="{% url 'users:logout' %}">
                        <i class="fas fa-sign-out-alt me-3"></i>Sair
                    </a>
                </li>
            </ul>
        {% else %}
            <!-- Menu para usuários não logados -->
            <ul class="list-group list-group-flush">
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center" href="{% url 'ads:home' %}">
                        <i class="fas fa-home me-3"></i>Início
                    </a>
                </li>
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center" href="{% url 'users:login' %}">
                        <i class="fas fa-sign-in-alt me-3"></i>Entrar
                    </a>
                </li>
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center" href="{% url 'users:register' %}">
                        <i class="fas fa-user-plus me-3"></i>Cadastrar
                    </a>
                </li>
                <li class="list-group-item border-0 px-0">
                    <a class="nav-link d-flex align-items-center" href="{% url 'help' %}">
                        <i class="fas fa-question-circle me-3"></i>Ajuda
                    </a>
                </li>
            </ul>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Garantir que Bootstrap dropdowns funcionem corretamente
    console.log('Inicializando dropdowns do Bootstrap...');
    
    // Inicializar dropdown do usuário explicitamente
    const userDropdownBtn = document.getElementById('userDropdownBtn');
    if (userDropdownBtn) {
        // Remover qualquer inicialização anterior
        const existingDropdown = bootstrap.Dropdown.getInstance(userDropdownBtn);
        if (existingDropdown) {
            existingDropdown.dispose();
        }
        
        // Criar nova instância do dropdown
        try {
            const dropdown = new bootstrap.Dropdown(userDropdownBtn, {
                boundary: 'viewport',
                display: 'dynamic'
            });
            console.log('Dropdown do usuário inicializado com sucesso');
            
            // Adicionar listeners para debug
            userDropdownBtn.addEventListener('show.bs.dropdown', function () {
                console.log('Dropdown sendo aberto');
            });
            
            userDropdownBtn.addEventListener('shown.bs.dropdown', function () {
                console.log('Dropdown aberto com sucesso');
            });
            
            userDropdownBtn.addEventListener('hide.bs.dropdown', function () {
                console.log('Dropdown sendo fechado');
            });
            
        } catch (error) {
            console.error('Erro ao inicializar dropdown:', error);
        }
    } else {
        console.warn('Botão do dropdown do usuário não encontrado');
    }

    // Header scroll effect
    const header = document.getElementById('modernHeader');
    let lastScrollTop = 0;
    
    window.addEventListener('scroll', () => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        if (scrollTop > 50) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
        
        lastScrollTop = scrollTop;
    });


    // Dynamic search placeholders
    const searchPlaceholders = [
        'Buscar Apartamento',
        'Buscar Serviços Diversos',
        'Buscar Produtos',
        'Buscar Consultoria',
        'Buscar Manutenção',
        'Buscar Tecnologia',
        'Buscar Alimentação',
        'Buscar Transporte',
        'Buscar Educação',
        'Buscar Saúde',
        'Buscar Beleza',
        'Buscar Construção',
        'Buscar Design',
        'Buscar Marketing',
        'Buscar Eventos'
    ];

    function getRandomPlaceholder() {
        return searchPlaceholders[Math.floor(Math.random() * searchPlaceholders.length)];
    }

    function updateSearchPlaceholders() {
        const desktopInput = document.getElementById('dynamicSearchInput');
        const mobileInput = document.getElementById('dynamicSearchInputMobile');
        const newPlaceholder = getRandomPlaceholder();
        
        if (desktopInput) desktopInput.placeholder = newPlaceholder;
        if (mobileInput) mobileInput.placeholder = newPlaceholder;
    }

    // Atualizar placeholder a cada 3 segundos
    setInterval(updateSearchPlaceholders, 3000);
    
    // Definir placeholder inicial aleatório
    updateSearchPlaceholders();

    // Search input animations
    const searchInputs = document.querySelectorAll('.search-input');
    searchInputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.style.transform = 'translateY(-1px)';
        });
        
        input.addEventListener('blur', function() {
            this.parentElement.style.transform = 'translateY(0)';
        });
    });

    // Add smooth animations to buttons
    const buttons = document.querySelectorAll('.cta-button, .search-btn, .notification-btn');
    buttons.forEach(button => {
        button.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px) scale(1.05)';
        });
        
        button.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });

    // Notification badge animation
    const badge = document.querySelector('.notification-badge');
    if (badge) {
        setInterval(() => {
            badge.style.transform = 'scale(1.1)';
            setTimeout(() => {
                badge.style.transform = 'scale(1)';
            }, 200);
        }, 3000);
    }
});
</script>
