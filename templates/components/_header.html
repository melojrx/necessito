{% load static %}
{% load chat_tags %}

<header>
<style>
    /* ===== MOBILE-FIRST HEADER OPTIMIZATION ===== */
    
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
    }
    .loading-spinner .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 123, 255, 0.1);
        border-radius: 50%;
        border-top: 4px solid #007bff;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ===== BARRA DE BUSCA MODERNA (DESKTOP + MOBILE) ===== */
    .search-bar {
        border: 2px solid #e9ecef;
        background: #fff;
        transition: all 0.3s ease;
        border-radius: 50px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        padding: 4px;
        display: flex;
        align-items: center;
        min-height: 48px;
    }
    
    .search-bar:focus-within {
        border-color: #0d6efd;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
        transform: translateY(-1px);
    }
    
    .search-bar input {
        border: none;
        outline: none;
        box-shadow: none;
        background: transparent;
        padding: 12px 16px;
        font-size: 0.95rem;
        flex: 1;
    }
    
    .search-bar input::placeholder {
        color: #6c757d;
        font-weight: 400;
    }
    
    .search-divider {
        width: 1px;
        height: 24px;
        background: #dee2e6;
        margin: 0 8px;
    }
    
    .search-location-dropdown {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 25px;
        transition: background 0.2s ease;
        border: none;
        background: transparent;
        min-width: 120px;
    }
    
    .search-location-dropdown:hover {
        background: rgba(13, 110, 253, 0.05);
    }
    
    .search-location-dropdown i {
        color: #0d6efd;
        margin-right: 6px;
    }
    
    .search-submit-btn {
        background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.3s ease;
        margin-right: 4px;
    }
    
    .search-submit-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    }
    
    .search-submit-btn i {
        font-size: 1rem;
    }

    /* Header mais compacto para mobile */
    @media (max-width: 767px) {
        .navbar {
            padding: 8px 0 !important;
            min-height: 60px;
        }
        
        .navbar-brand img {
            height: 45px !important;
        }
        
        .navbar-brand span {
            font-size: 1.4rem !important;
            margin-top: 0 !important;
        }
        
        /* Texto compacto para mobile */
        .mobile-text-small {
            font-size: 0.75rem !important;
            margin-left: 4px;
        }
        
        /* Barra de busca expandida quando menu aberto */
        .navbar-collapse.show .search-container {
            width: 100% !important;
            margin: 12px 0;
        }
        
        .navbar-collapse.show .search-bar {
            width: 100% !important;
        }
        
        /* Simplificar barra de busca no mobile */
        .search-bar {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 25px;
            padding: 8px 16px;
            margin: 8px 0;
            min-height: 44px;
        }
        
        .search-bar input {
            font-size: 0.9rem;
            padding: 8px 0;
        }
        
        /* Ocultar elementos complexos no mobile */
        .search-divider,
        .search-location-dropdown {
            display: none !important;
        }
        
        .search-submit-btn {
            width: 32px;
            height: 32px;
            margin-right: 0;
        }
        
        /* Dropdown do menu mais compacto */
        .navbar-nav .nav-link {
            padding: 8px 16px !important;
            font-size: 0.9rem;
        }
        
        /* Ícones menores no mobile */
        .navbar-nav .nav-link i {
            font-size: 1rem;
        }
        
        /* Ajustar alinhamento dos itens de menu */
        .navbar-nav .nav-item {
            display: flex;
            align-items: center;
        }
    }

    /* Layout desktop otimizado */
    @media (min-width: 768px) {
        .search-container {
            max-width: 500px;
            flex: 1;
        }
        
        .search-bar {
            width: 100%;
        }
    }

    .bell-animation {
        animation: bellShake 2s infinite;
        transform-origin: top center;
    }
    @keyframes bellShake {
        0% { transform: rotate(0); }
        15% { transform: rotate(5deg); }
        30% { transform: rotate(-5deg); }
        45% { transform: rotate(4deg); }
        60% { transform: rotate(-4deg); }
        75% { transform: rotate(2deg); }
        85% { transform: rotate(-2deg); }
        92% { transform: rotate(1deg); }
        100% { transform: rotate(0); }
    }
</style>

<nav class="navbar navbar-expand-lg bg-body-tertiary py-2 py-lg-3">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
        <img src="{% static 'img/logo2.png' %}" alt="indicaai.br" height="80" class="d-inline-block align-top me-2">
  
        <!-- MOBILE: Logo mais próximo do design -->
        <span class="d-block d-lg-none"
            style="font-size: 2rem; font-weight: 700; color: #2c3e50; font-family: 'Segoe UI', 'Roboto', sans-serif; margin-top: 0.2rem;">
        Indicaai
        </span>

  
        <!-- Nome no DESKTOP -->
        <span class="fs-3 fw-semibold d-none d-lg-block" style="color: #545b62;">Indicaai</span>
      </a>
  
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
  
      <div class="collapse navbar-collapse mt-2 mt-lg-0" id="navbarNav">
        <ul class="navbar-nav me-auto align-items-start">
          <li class="nav-item flex-grow-1 me-auto search-container">
            <form method="get" action="{% url 'search:necessidade_search_all' %}" class="w-100">
              <input type="hidden" name="state" id="stateInput" value="{{ selected_state|default:'todos' }}">
              <div class="search-bar">
                <input type="text" name="q" class="flex-grow-1"
                  placeholder='Buscar por produtos, serviços...' value="{{ request.GET.q|default:'' }}" autocomplete="off">
                
                <!-- Divisor e dropdown de estado (apenas desktop) -->
                <div class="search-divider d-none d-md-block"></div>
                <div class="dropdown d-none d-md-block">
                  <button class="search-location-dropdown dropdown-toggle" type="button"
                    data-bs-toggle="dropdown" aria-expanded="false" id="stateButton">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ selected_state|default:'Todos os estados' }}</span>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0" aria-labelledby="stateButton" style="border-radius: 12px;">
                    <li><a class="dropdown-item {% if selected_state == 'todos' %}active{% endif %}" href="#" data-state="todos">
                      <i class="fas fa-globe me-2 text-primary"></i> Todos os estados
                    </a></li>
                    {% for st in states %}
                    <li><a class="dropdown-item {% if selected_state == st.abbreviation %}active{% endif %}"
                        href="#" data-state="{{ st.abbreviation }}">
                        <i class="fas fa-map-marker-alt me-2 text-secondary"></i> {{ st.abbreviation }}
                    </a></li>
                    {% endfor %}
                  </ul>
                </div>
                
                <button class="search-submit-btn" type="submit" aria-label="Pesquisar">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </form>
          </li>
        </ul>
  
        <ul class="navbar-nav ms-auto align-items-start justify-content-end mt-2 mt-lg-0">
          <li class="nav-item">
            <a href="{% url 'help' %}" class="nav-link d-flex align-items-center">
              <i class="fas fa-question-circle me-2"></i>
              <span class="d-none d-md-inline d-lg-inline">Ajuda</span>
              <span class="d-block d-md-none mobile-text-small">Ajuda</span>
            </a>
          </li>
          <li class="nav-item position-relative">
            <button class="btn btn-link nav-link d-flex align-items-center" type="button" data-bs-toggle="offcanvas"
              data-bs-target="#offcanvasNotifications">
              <i class="fas fa-bell me-2 {% if unread_notifications_count > 0 %}bell-animation{% endif %}"></i>
              <span class="d-none d-md-inline d-lg-inline">Notificações</span>
              <span class="d-block d-md-none mobile-text-small">Notificações</span>
              {% if unread_notifications_count > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ unread_notifications_count }}
              </span>
              {% endif %}
            </button>
          </li>

          {% if user.is_authenticated %}
          <li class="nav-item dropdown mb-2">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-user me-2 d-lg-none"></i>
                <span class="d-none d-md-inline d-lg-inline">Olá, {{ user.first_name|capfirst }}!</span>
                <span class="d-block d-md-none mobile-text-small">{{ user.first_name|capfirst|truncatechars:8 }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="{% url 'minha_conta_detail' user.pk %}"><i class="fas fa-user"></i> Minha Conta</a></li>
              <li><a class="dropdown-item" href="{% url 'necessidade_list' %}"><i class="fas fa-bullhorn"></i> Meus Anúncios</a></li>
              <li><a class="dropdown-item" href="{% url 'budget_list' %}"><i class="far fa-list-alt"></i> Meus Orçamentos</a></li>
              <li> <!-- LINK DO CHAT COM CONTADOR -->
                <a class="dropdown-item d-flex align-items-center justify-content-between" href="{% url 'chat:lista_chats' %}">
                    <span>
                        <i class="fas fa-comments me-2"></i> Chats
                    </span>
                    {% if unread_messages_count > 0 %}
                        <span class="badge rounded-pill bg-danger ms-2">
                            {{ unread_messages_count }}
                            <span class="visually-hidden">mensagens não lidas</span>
                        </span>
                    {% endif %}
                </a></li>
              {% if user.is_staff %}
              <li><a class="dropdown-item" href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
              {% endif %}
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
            </ul>
          </li>
          {% else %}
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center" href="{% url 'login' %}">
              <i class="fas fa-sign-in-alt me-2"></i> 
              <span class="d-none d-md-inline d-lg-inline">Login</span>
              <span class="d-block d-md-none mobile-text-small">Login</span>
            </a>
          </li>
          <li class="nav-item ms-lg-3">
            <a class="nav-link d-flex align-items-center" href="{% url 'register' %}">
              <i class="fas fa-user-plus me-2"></i> 
              <span class="d-none d-md-inline d-lg-inline">Registrar</span>
              <span class="d-block d-md-none mobile-text-small">Cadastrar</span>
            </a>
          </li>
          {% endif %}
  
          <!-- Botão Anunciar: Oculto no mobile (temos FAB), visível no desktop -->
          <li class="nav-item ms-lg-3 d-none d-lg-block">
            <a href="{% url 'necessidade_create' %}" class="btn btn-primary text-white px-4 py-2 rounded-pill d-flex align-items-center justify-content-center" style="font-size: 14px; height: 45px; min-width: 180px;">
              <i class="fas fa-bullhorn me-2"></i> Anunciar grátis
            </a>
          </li>
        </ul>
      </div>
    </div>
</nav>
  
    <!-- Off Canvas Notificações -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifications" aria-labelledby="offcanvasNotificationsLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasNotificationsLabel" style="color: #0B5ED7;">
                <i class="fa-solid fa-bell"></i> Notificações
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            {% if user.is_authenticated %}
                <div class="d-flex justify-content-end mb-3">
                    <a href="{% url 'notification_mark_all_read' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-check-double me-1"></i> Marcar todas como lidas
                    </a>
                </div>
                
                <!-- Container para as notificações -->
                <div class="list-group" id="notifications-container">
                    <!-- As notificações serão carregadas aqui via AJAX -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Link para ver todas - removido temporariamente -->
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i> 
                        Mostrando as 5 notificações mais recentes
                    </small>
                </div>
                
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-user-lock fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Faça login para ver suas notificações.</p>
                    <a href="{% url 'login' %}" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt me-1"></i> Fazer Login
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

</header>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.querySelector('.search-bar input[name="q"]');
        const stateInput = document.getElementById('stateInput');
        const stateButton = document.getElementById('stateButton');
        const stateDropdown = document.querySelectorAll('.dropdown-item[data-state]');

        // Atualizar estado selecionado
        stateDropdown.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedState = this.getAttribute('data-state');
                const stateName = selectedState === 'todos' ? 'Todos os estados' : selectedState;
                
                stateInput.value = selectedState;
                
                // Atualizar o texto do botão
                const buttonText = stateButton.querySelector('span');
                if (buttonText) {
                    buttonText.textContent = stateName;
                }
                
                // Remover classe active de todos
                stateDropdown.forEach(dropdown => dropdown.classList.remove('active'));
                // Adicionar classe active ao selecionado
                this.classList.add('active');
            });
        });

        // Carregar notificações quando o offcanvas for aberto
        const notificationsOffcanvas = document.getElementById('offcanvasNotifications');
        if (notificationsOffcanvas) {
            notificationsOffcanvas.addEventListener('shown.bs.offcanvas', function () {
                loadNotifications();
            });
        }

        function loadNotifications() {
            const container = document.getElementById('notifications-container');
            if (!container) return;

            fetch('{% url "get_notifications" %}')
                .then(response => response.json())
                .then(data => {
                    // A view retorna HTML renderizado
                    container.innerHTML = data.html;
                })
                .catch(error => {
                    console.error('Erro ao carregar notificações:', error);
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                            <p class="text-muted">Erro ao carregar notificações.</p>
                        </div>
                    `;
                });
        }
    });
</script>