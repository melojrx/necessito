<!-- Real-time notifications via WebSocket -->
{% if user.is_authenticated %}
<div id="user-data" data-user-id="{{ user.id }}" style="display: none;"></div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configura√ß√£o do usu√°rio atual
    const userDataElement = document.getElementById('user-data');
    const currentUserId = parseInt(userDataElement.getAttribute('data-user-id'));
    
    let notificationSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectDelay = 3000;

    // Conectar ao WebSocket para notifica√ß√µes
    function connectNotifications() {
        try {
            console.log('üöÄ Iniciando conex√£o WebSocket para notifica√ß√µes...');
            console.log('üë§ ID do usu√°rio:', currentUserId);
            
            // Conectar ao namespace de chat
            notificationSocket = io('/chat', {
                transports: ['websocket', 'polling'],
                upgrade: true,
                query: 'user_id=' + currentUserId,
                timeout: 5000,
                forceNew: false
            });

            notificationSocket.on('connect', function() {
                console.log('üîó Conectado ao WebSocket com ID:', notificationSocket.id);
                reconnectAttempts = 0;
                
                // Entrar na sala pessoal do usu√°rio
                console.log('üè† Entrando na sala pessoal...');
                notificationSocket.emit('join_user_room', {
                    user_id: currentUserId
                });
            });

            notificationSocket.on('disconnect', function() {
                console.log('‚ùå Desconectado do sistema de notifica√ß√µes');
                // Tentar reconectar
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(function() {
                        reconnectAttempts++;
                        console.log('üîÑ Tentativa de reconex√£o ' + reconnectAttempts + '/' + maxReconnectAttempts);
                        connectNotifications();
                    }, reconnectDelay);
                }
            });

            // Confirma√ß√£o de entrada na sala de notifica√ß√µes
            notificationSocket.on('notification_room_joined', function(data) {
                console.log('‚úÖ Sala de notifica√ß√µes joinada:', data);
            });

            // Receber nova notifica√ß√£o
            notificationSocket.on('new_notification', function(data) {
                console.log('üîî Nova notifica√ß√£o recebida:', data);
                handleNewNotification(data);
            });

            // Atualizar contadores
            notificationSocket.on('update_counters', function(data) {
                console.log('üìä Atualizando contadores:', data);
                updateNotificationCounters(data);
            });

            // Eventos de debug
            notificationSocket.on('connect_error', function(error) {
                console.error('‚ùå Erro de conex√£o WebSocket:', error);
            });

            notificationSocket.on('error', function(error) {
                console.error('‚ùå Erro WebSocket:', error);
            });

        } catch (error) {
            console.error('‚ùå Erro ao conectar WebSocket de notifica√ß√µes:', error);
        }
    }

    // Processar nova notifica√ß√£o
    function handleNewNotification(data) {
        console.log('üéØ Processando notifica√ß√£o:', data);
        
        // Atualizar contadores visuais
        updateNotificationCounters();
        
        // Mostrar toast de notifica√ß√£o
        showNotificationToast(data);
        
        // Tocar som se n√£o estiver no chat
        if (!isInChatPage(data.chat_id)) {
            playNotificationSound();
        }
        
        // Atualizar lista de notifica√ß√µes se estiver aberta
        const offcanvas = document.getElementById('offcanvasNotifications');
        if (offcanvas && offcanvas.classList.contains('show')) {
            loadNotifications();
        }
    }

    // Atualizar contadores na interface
    function updateNotificationCounters(data) {
        if (data) {
            updateCounterElement('.notification-counter', data.unread_notifications);
            updateCounterElement('.message-counter', data.unread_messages);
            updateBellAnimation(data.unread_notifications > 0);
        } else {
            // Buscar contadores via AJAX
            fetch('{% url "get_notification_counts" %}')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    updateCounterElement('.notification-counter', data.unread_notifications);
                    updateCounterElement('.message-counter', data.unread_messages);
                    updateBellAnimation(data.unread_notifications > 0);
                })
                .catch(function(error) { 
                    console.error('Erro ao buscar contadores:', error); 
                });
        }
    }

    // Atualizar elemento contador
    function updateCounterElement(selector, count) {
        const elements = document.querySelectorAll(selector);
        elements.forEach(function(element) {
            if (count > 0) {
                element.textContent = count;
                element.style.display = 'inline';
            } else {
                element.style.display = 'none';
            }
        });
    }

    // Ativar/desativar anima√ß√£o do sino
    function updateBellAnimation(hasNotifications) {
        const bellIcon = document.querySelector('.fas.fa-bell');
        if (bellIcon) {
            if (hasNotifications) {
                bellIcon.classList.add('bell-animation');
            } else {
                bellIcon.classList.remove('bell-animation');
            }
        }
    }

    // Mostrar toast de notifica√ß√£o
    function showNotificationToast(data) {
        console.log('üçû Mostrando toast para:', data);
        
        const toastContainer = getOrCreateToastContainer();
        const toastId = 'toast-' + Date.now();
        
        const toastElement = document.createElement('div');
        toastElement.id = toastId;
        toastElement.className = 'toast align-items-center';
        toastElement.setAttribute('role', 'alert');
        toastElement.innerHTML = 
            '<div class="d-flex">' +
                '<div class="toast-body">' +
                    '<div class="d-flex align-items-center">' +
                        '<i class="fas fa-comments text-primary me-2"></i>' +
                        '<div>' +
                            '<strong>' + data.from_user + '</strong> enviou uma mensagem' +
                            '<br><small class="text-muted">"' + data.message_preview + '"</small>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>' +
            '</div>';
        
        toastContainer.appendChild(toastElement);
        
        // Adicionar click handler para ir ao chat
        toastElement.addEventListener('click', function() {
            window.location.href = '/chat/' + data.chat_id + '/websocket/';
        });
        
        // Mostrar toast
        const toast = new bootstrap.Toast(toastElement, {
            delay: 5000
        });
        toast.show();
        
        // Remover elemento ap√≥s dismiss
        toastElement.addEventListener('hidden.bs.toast', function() {
            if (toastContainer.contains(toastElement)) {
                toastContainer.removeChild(toastElement);
            }
        });
    }

    // Obter ou criar container de toasts
    function getOrCreateToastContainer() {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }
        return container;
    }

    // Tocar som de notifica√ß√£o
    function playNotificationSound() {
        try {
            // Som discreto de notifica√ß√£o
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMcAjiS3fPNdCgHK2+/7+KWTQ4NVKzh7q1SFAxEn+PxwGIYAzaR3PerYxkHHIzQ6d6NCggTX7Xj7qVYGQlAnN7rw2EUAj2J0OrehwYDFnPE5diMOggZYLTi7qNaGgdAnN3ux2IRBDiMzurZhwQFGG7A49iHOwkSWrLr7JdTEg1Hnt3sxGEJBTPE7+WBCAICFXzI5NGFOAcPXbHh5qNEGAk8ltryxWsiBDCN1+2/eScFLYTK7duMOwgZZLft5pJEDgxQq+nuvGMZAzON2fHMeS8FKmzB8N+MQAkTYLLi7qZSEgxMo+LtyGMVBDOO0uyEFT');
            audio.volume = 0.3;
            audio.play().catch(function() {}); // Ignorar erros
        } catch (e) {
            // Ignorar erros de √°udio
        }
    }

    // Verificar se est√° na p√°gina de chat
    function isInChatPage(chatId) {
        return window.location.pathname.includes('/chat/' + chatId + '/');
    }

    // Recarregar notifica√ß√µes
    function loadNotifications() {
        const container = document.getElementById('notifications-container');
        if (!container) return;

        fetch('{% url "get_notifications" %}')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                container.innerHTML = data.html;
            })
            .catch(function(error) {
                console.error('Erro ao carregar notifica√ß√µes:', error);
            });
    }

    // Inicializar conex√£o
    console.log('üîç Verificando disponibilidade do Socket.IO...');
    if (typeof io !== 'undefined') {
        console.log('‚úÖ Socket.IO dispon√≠vel, iniciando conex√£o...');
        connectNotifications();
    } else {
        console.warn('‚ùå Socket.IO n√£o est√° dispon√≠vel. Notifica√ß√µes em tempo real desabilitadas.');
    }

    // Atualizar contadores periodicamente como fallback
    setInterval(updateNotificationCounters, 30000); // A cada 30 segundos
});
</script>

<!-- CSS para toasts de notifica√ß√£o -->
<style>
.toast {
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 300px;
}

.toast:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
}

.toast-body {
    padding: 16px !important;
}

.notification-counter, .message-counter {
    background: #dc3545 !important;
    color: white !important;
    border-radius: 50% !important;
    padding: 2px 6px !important;
    font-size: 0.75rem !important;
    font-weight: bold !important;
    min-width: 18px !important;
    height: 18px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* Manter anima√ß√£o do sino */
.bell-animation {
    animation: bellShake 2s infinite !important;
    transform-origin: top center !important;
}

@keyframes bellShake {
    0% { transform: rotate(0); }
    15% { transform: rotate(5deg); }
    30% { transform: rotate(-5deg); }
    45% { transform: rotate(4deg); }
    60% { transform: rotate(-4deg); }
    75% { transform: rotate(2deg); }
    85% { transform: rotate(-2deg); }
    92% { transform: rotate(1deg); }
    100% { transform: rotate(0); }
}

/* Container de toasts */
#toast-container {
    z-index: 9999 !important;
}
</style>
{% endif %} 